
(function($){$.fn.TextAreaExpander=function(minHeight,maxHeight){var hCheck=!($.browser.msie||$.browser.opera);function ResizeTextarea(e){e=e.target||e;var vlen=e.value.length,ewidth=e.offsetWidth;if(vlen!=e.valLength||ewidth!=e.boxWidth){var scrollTop=$(document).scrollTop();if(hCheck&&(vlen<e.valLength||ewidth!=e.boxWidth))e.style.height=e.expandMin+"px";var h=Math.max(e.expandMin,Math.min(e.scrollHeight,e.expandMax));e.style.overflow=(e.scrollHeight>h?"auto":"hidden");e.style.height=h+"px";$.scrollTo(scrollTop);e.valLength=vlen;e.boxWidth=ewidth;}
return true;};this.each(function(){if(this.nodeName.toLowerCase()!="textarea")return;var p=this.className.match(/expand(\d+)\-*(\d+)*/i);this.expandMin=minHeight||(p?parseInt('0'+p[1],10):0);this.expandMax=maxHeight||(p?parseInt('0'+p[2],10):99999);$(this).css('box-sizing','border-box');ResizeTextarea(this);if(!this.Initialized){this.Initialized=true;$(this).bind("keyup focus input",ResizeTextarea);}});return this;};})(jQuery);(function($){$.fn.autoGrowInput=function(o){o=$.extend({maxWidth:1000,minWidth:0,comfortZone:70},o);this.filter('input:text').each(function(){var minWidth=o.minWidth||$(this).width(),val='',input=$(this),testSubject=$('<div/>').css({position:'absolute',top:-9999,left:-9999,width:'auto',fontSize:input.css('fontSize'),fontFamily:input.css('fontFamily'),fontWeight:input.css('fontWeight'),letterSpacing:input.css('letterSpacing'),whiteSpace:'nowrap'}),check=function(){val=input.val();var escaped=val.replace(/&/g,'&amp;').replace(/\s/g,' ').replace(/</g,'&lt;').replace(/>/g,'&gt;');testSubject.html(escaped);var testerWidth=testSubject.width(),newWidth=(testerWidth+o.comfortZone)>=minWidth?testerWidth+o.comfortZone:minWidth,currentWidth=input.width(),newWidth=Math.max(minWidth,Math.min(newWidth,o.maxWidth));input.width(newWidth);};testSubject.insertAfter(input);$(this).bind('keyup keydown blur update',check);});return this;};})(jQuery);var ETScrubber={header:null,body:null,scrubber:null,items:null,loadItemsCallback:null,scrollToIndexCallback:null,count:0,startFrom:0,perPage:0,moreText:"Load more",loadedItems:[],init:function(){var count=Math.min(this.startFrom+this.perPage,this.count);for(var i=this.startFrom;i<count;i++)
this.loadedItems.push(i);this.header=$("#hdr");var headerTop=this.header.offset().top;var headerWidth=this.header.width();var scrubberTop=this.scrubber.length&&(this.scrubber.offset().top-this.header.outerHeight()-20);$(window).scroll(function(){var y=$(this).scrollTop();if(y>=scrubberTop&&!ET.disableFixedPositions){ETScrubber.scrubber.addClass("floating").css({position:"fixed",top:ETScrubber.header.outerHeight()+20,zIndex:100});}
else{ETScrubber.scrubber.removeClass("floating").css({position:"",top:""});}
$("li",ETScrubber.items).each(function(){var item=$(this);if(y>item.offset().top+item.outerHeight()-ETScrubber.header.outerHeight())return true;else{$(".scrubber li").removeClass("selected");var index=item.data("index");if($(document).scrollTop()<=0&&ETScrubber.loadedItems.indexOf(0)!=-1)index="op";$(".scrubber-"+index,ETScrubber.scrubber).addClass("selected").parents("li").addClass("selected");return false;}});var newer=$(".scrubberNext",ETScrubber.body);if(newer.length&&y+$(window).height()>newer.offset().top&&!newer.hasClass("loading")&&!ET.disableFixedPositions){newer.find("a").click();}});$(".scrubberMore a",ETScrubber.body).live("click",function(e){e.preventDefault();$(this).parent().addClass("loading");var moreItem=$(this).parent();var backwards,position;if(moreItem.is(".scrubberPrevious")){backwards=true;position=Math.min.apply(Math,ETScrubber.loadedItems)-ETScrubber.perPage;}
else if(moreItem.is(".scrubberNext")){backwards=false;position=Math.max.apply(Math,ETScrubber.loadedItems)+1;}
else{backwards=moreItem.offset().top-$(document).scrollTop()<250;position=backwards?$(this).parent().data("positionEnd")-ETScrubber.perPage+1:$(this).parent().data("positionStart");}
ETScrubber.loadItemsCallback(position,function(data){if(backwards){var firstItem=moreItem.next();var scrollOffset=firstItem.offset().top-$(document).scrollTop();}
var items=ETScrubber.addItems(data.startFrom,data.view,moreItem);if(backwards)
$.scrollTo(firstItem.offset().top-scrollOffset);return items;});});$(".scrubber a",ETScrubber.body).click(function(e){e.preventDefault();var index=$(this).parent().data("index");if(index=="last")index=Infinity;else if(index=="first")index=0;var found=ETScrubber.scrollToIndex(index);if(!found){var moreItem=null,prevPost=null;$("li",ETScrubber.items).each(function(){if($(this).is(".scrubberMore"))moreItem=$(this);else{var item=$(this).first();if(item.data("index")>index)
return false;moreItem=null;prevPost=$(this);}});if(!moreItem&&!prevPost)
ETScrubber.scrollTo(0);else if(!moreItem&&prevPost&&index!=Infinity)
ETScrubber.scrollTo(prevPost.offset().top);else if(moreItem){ETScrubber.scrollTo(moreItem.offset().top);moreItem.addClass("loading");ETScrubber.loadItemsCallback(index,function(data){if(index==Infinity)var scrollOffset=ETScrubber.items.offset().top+ETScrubber.items.outerHeight()-$(document).scrollTop();var items=ETScrubber.addItems(data.startFrom,data.view,moreItem);if(index==Infinity)$.scrollTo(ETScrubber.items.offset().top+ETScrubber.items.outerHeight()-scrollOffset);else ETScrubber.scrollToIndex(index);return items;},true);}}});},scrollTo:function(position){$.scrollTo(Math.max(0,position-ETScrubber.header.outerHeight()),"slow");},scrollToIndex:function(index){var post=null,found=false,item;$("li",ETScrubber.items).each(function(){item=$(this);if(item.data("index")==index){found=true;return false;}
if(item.data("index")>index)
return false;});if(item)ETScrubber.scrollTo(index==0?0:$(item).offset().top);if(typeof ETScrubber.scrollToIndexCallback=="function")ETScrubber.scrollToIndexCallback(index);return found;},addItems:function(startFrom,items,moreItem,animate){startFrom=parseInt(startFrom);moreItem.removeClass("loading");var view=$(items);view=view.filter("li");var items=[],newStartFrom=startFrom;for(var i=0;i<ETScrubber.perPage;i++){if(startFrom+i>=ETScrubber.count)break;if(ETScrubber.loadedItems.indexOf(startFrom+i)!=-1){if(items.length)break;newStartFrom=startFrom+i+1;continue;}
items.push(view[i]);}
startFrom=newStartFrom;items=$(items);if($("div.timeMarker[data-now]",ETScrubber.body).length){items.find("div.timeMarker[data-now]").remove();}
if(moreItem.is(".scrubberPrevious"))
moreItem.after(items);else if(moreItem.is(".scrubberNext"))
moreItem.before(items);else if(items.length)
moreItem.replaceWith(items);var scrubberMore=$("<li class='scrubberMore'><a href='#'>"+ETScrubber.moreText+"</a></li>");if(ETScrubber.loadedItems.indexOf(startFrom-1)==-1&&items.first().prev().is("li:not(.scrubberMore)")){scrubberMore=scrubberMore.clone();items.first().before(scrubberMore);for(var i=startFrom-1;i>0;i--){if(ETScrubber.loadedItems.indexOf(i)!=-1)break;}
scrubberMore.data("positionStart",i+1);scrubberMore.data("positionEnd",startFrom-1);}
if(ETScrubber.loadedItems.indexOf(startFrom+items.length)==-1&&items.last().next().is("li:not(.scrubberMore)")){scrubberMore=scrubberMore.clone();items.last().after(scrubberMore);for(var i=startFrom+items.length+1;i<ETScrubber.count;i++){if(ETScrubber.loadedItems.indexOf(i)!=-1)break;}
scrubberMore.data("positionStart",startFrom+items.length);scrubberMore.data("positionEnd",i-1);}
if(animate)items.hide().fadeIn("slow");for(var i=startFrom;i<startFrom+items.length;i++){if(ETScrubber.loadedItems.indexOf(i)==-1)
ETScrubber.loadedItems.push(i);}
if(Math.min.apply(Math,ETScrubber.loadedItems)<=0)
$(".scrubberPrevious").remove();if(Math.max.apply(Math,ETScrubber.loadedItems)>=ETScrubber.count-1)
$(".scrubberNext").remove();return items;}};function ETAutoCompletePopup(field,character,clickHandler){var ac=this;this.field=field;this.character=character;this.active=false;this.items=0;this.index=0;this.cache=[];this.searches=[];this.value="";this.clickHandler=clickHandler;if(!this.clickHandler)this.clickHandler=function(member){var selection=ac.field.getSelection();var value=ac.field.val();var nameStart=0;if(selection.length==0){for(var i=selection.start;i>selection.start-20;i--){if(i!=selection.start&&(value.substr(i,1)=="]"))break;if(value.substr(i,ac.character.length)==ac.character){nameStart=i+ac.character.length;break;}}
if(nameStart){ac.field.val(value.substring(0,nameStart)+member["name"]+" "+value.substr(selection.start));var p=nameStart+member["name"].length+1;ac.field.selectRange(p,p);}}};this.popup=$("#autoCompletePopup-"+field.attr("id"));if(!this.popup.length)this.popup=$("<div id='autoCompletePopup-"+field.attr("id")+"'/>");this.popup.bind("mouseup",function(e){return false;}).addClass("popup").addClass("autoCompletePopup").hide();this.popup.appendTo("body");$(document).mouseup(function(e){ac.hide();});this.field.attr("autocomplete","off").keydown(function(e){if(ac.active){switch(e.which){case 40:ac.updateIndex(ac.index+1);e.preventDefault();break;case 38:ac.updateIndex(ac.index-1);e.preventDefault();break;case 13:case 9:ac.popup.find("li").eq(ac.index).click();e.preventDefault();break;case 27:ac.hide();e.stopPropagation();e.preventDefault();break;}}});this.field.keyup(function(e){switch(e.which){case 27:if(ac.active)e.stopPropagation();break;case 9:case 13:case 27:case 40:case 38:case 37:case 39:break;default:if(ac.character){var selection=$(this).getSelection();var value=$(this).val();var nameStart=0;if(selection.length==0){for(var i=selection.start;i>selection.start-20;i--){if(i!=selection.start&&value.substr(i,1)=="]")break;if(value.substr(i,ac.character.length)==ac.character){nameStart=i+ac.character.length;break;}}
if(nameStart){var name=value.substring(nameStart,selection.start);ac.fetchNewContent(name);}}}
else ac.fetchNewContent($(this).val());break;}});this.update=function(){if(ac.value){var value=ac.value.replace(/ /g,"\xA0");value=value.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");var regexp=new RegExp("("+value+")","i");var results=[];for(var i in ac.cache){if(regexp.test(ac.cache[i].name)){results.push(ac.cache[i]);}}
ac.popup.html("<ul class='popupMenu'></ul>");if(results.length){results=results.sort(function(a,b){return a.name==b.name?0:(a.name<b.name?-1:1);});results=results.slice(0,5);var item;for(var i in results){var name=$("<div/>").text(results[i].name).html();name=name.replace(regexp,"<strong>$1</strong>");item=$("<li><a href='#'><i>"+results[i].avatar+"</i> "+name+"</a></li>").data("position",i).data("member",results[i]).mouseover(function(){ac.updateIndex($(this).data("position"));}).click(function(e){e.preventDefault();ac.clickHandler($(this).data("member"));ac.stop();});ac.popup.find("ul").append(item);}
ac.items=results.length;ac.active=true;ac.show();ac.updateIndex(ac.index);}
else ac.hide();}else ac.hide();}
this.timeout=null;this.fetchNewContent=function(value){if(value&&value!=ac.value&&ac.searches.indexOf(value)==-1&&value.length>2){clearTimeout(ac.timeout);ac.timeout=setTimeout(function(){$.ETAjax({id:"autoComplete",url:"members/autocomplete.ajax/"+encodeURIComponent(value),global:false,success:function(data){results:for(var i in data.results){for(var j in ac.cache){if(ac.cache[j].type==data.results[i].type&&ac.cache[j].memberId==data.results[i].memberId)continue results;}
ac.cache.push(data.results[i]);}
ac.searches.push(value);ac.update();}});},250);}
ac.value=value;ac.update();}
this.show=function(){ac.popup.show().css({position:"absolute",zIndex:9999});if(ac.character){var selection=ac.field.getSelection();var value=ac.field.val().substr(0,selection.start-ac.value.length);var testSubject=$('<div/>').css({position:'absolute',top:ac.field.offset().top,left:ac.field.offset().left,width:ac.field.width(),height:ac.field.height(),fontSize:ac.field.css('fontSize'),fontFamily:ac.field.css('fontFamily'),fontWeight:ac.field.css('fontWeight'),paddingTop:ac.field.css('paddingTop'),paddingLeft:ac.field.css('paddingLeft'),paddingRight:ac.field.css('paddingRight'),paddingBottom:ac.field.css('paddingBottom'),letterSpacing:ac.field.css('letterSpacing'),lineHeight:ac.field.css('lineHeight')}).html(value.replace(/[\n\r]/g,"<br/>")).appendTo("body").append("<span style='position:absolute'>&nbsp;</span>");var offset=testSubject.find("span").offset();ac.popup.css({left:offset.left,top:offset.top+testSubject.find("span").height()});testSubject.remove();}
else ac.popup.css({left:ac.field.offset().left,top:ac.field.offset().top+ac.field.outerHeight()-1,width:ac.field.outerWidth()});ac.active=true;}
this.hide=function(){ac.popup.hide();ac.active=false;}
this.stop=function(){ac.hide();clearTimeout(ac.timeout);$.ETAjax.abort("autoComplete");}
this.updateIndex=function(index)
{ac.index=index;if(ac.index<0)ac.index=ac.items-1;else if(ac.index>=ac.items)ac.index=0;ac.popup.find("li").removeClass("selected").eq(ac.index).addClass("selected");}};var ETConversation={id:0,title:"",channel:"",slug:"",startFrom:0,searchString:null,postCount:0,updateInterval:null,editingReply:false,editingPosts:0,init:function(){if(ET.conversation){this.id=ET.conversation.conversationId;this.postCount=ET.conversation.countPosts;this.startFrom=ET.conversation.startFrom;this.channel=ET.conversation.channel;this.slug=ET.conversation.slug;this.searchString=ET.conversation.searchString;if($("#conversationControls").length)
$("#conversationBody .scrubberContent").prepend($("#conversationControls").popup({alignment:"left",content:"<i class='icon-cog'></i> <span class='text'>"+T("Controls")+"</span> <i class='icon-caret-down'></i>"}).find(".button").addClass("big").end());ETScrubber.body=$("#conversation");ETScrubber.scrubber=$("#conversationBody .scrubberContent");ETScrubber.items=$("#conversationPosts");ETScrubber.count=this.postCount;ETScrubber.perPage=ET.postsPerPage;ETScrubber.moreText=T("Kuva rohkem postitusi");ETScrubber.startFrom=this.startFrom;ETScrubber.loadItemsCallback=function(position,success,index){if(position==Infinity)position="999999";if(index){position=(""+position).substr(0,4)+"/"+(""+position).substr(4,2);}
$.ETAjax({url:"conversation/index.ajax/"+ETConversation.id+"/"+position,data:{search:ETConversation.searchString},success:function(data){var items=success(data);ETConversation.collapseQuotes(items);ETConversation.redisplayAvatars();},global:false});}
ETScrubber.scrollToIndexCallback=function(index){var position;if(index==Infinity)position="last";else position=(""+index).substr(0,4)+"/"+(""+index).substr(4,2);$.history.load(ETConversation.slug+"/"+position,true);}
ETScrubber.init();$("#jumpToReply").click(function(e){e.preventDefault();$(".scrubber-now a").click();setTimeout(function(){$("#reply textarea").click();},1);});this.updateInterval=new ETIntervalCallback(this.update,ET.conversation.updateInterval);this.title=$("#conversationTitle a").text()||$("#conversationTitle").text();$("#conversationTitle a").live("click",function(e){e.preventDefault();ETConversation.editTitle();});$("#control-sticky").click(function(e){e.preventDefault();ETConversation.toggleSticky();});$("#control-lock").click(function(e){e.preventDefault();ETConversation.toggleLock();});$("#control-mute").click(function(e){e.preventDefault();ETConversation.toggleMute();});$("#control-delete").click(function(e){if(!ETConversation.confirmDelete())e.preventDefault();});this.initPosts();var hash=window.location.hash.replace("#","");if(hash.substr(0,1)=="p"&&$("#"+hash).length){ETConversation.highlightPost($("#"+hash));setTimeout(function(){ETConversation.scrollTo($("#"+hash).offset().top-10);},100);}
$(window).scroll(function(){var y=$(this).scrollTop();var title=$("#forumTitle");if(y>$("#hdr").height()){if(!title.data("old")){title.data("old",title.html()).html("<a href='#'></a>").find("a").text(ETConversation.title);title.find("a").click(function(e){e.preventDefault();$.scrollTo(0,"fast");});}}else if(title.data("old")){title.html(title.data("old")).data("old",null);}});}
else{$("#conversationTitle input").autoGrowInput({comfortZone:30,minWidth:300,maxWidth:500}).trigger("update");$("#membersAllowedSheet").parents("form").remove();ETConversation.changeChannel();}
$("#control-changeChannel").click(function(e){e.preventDefault();ETConversation.changeChannel();});$("#control-changeMembersAllowed").click(function(e){e.preventDefault();ETConversation.changeMembersAllowed();});$(".channels a").tooltip({alignment:"left",delay:250,className:"withArrow withArrowBottom"});ETMembersAllowedTooltip.init($("#conversationPrivacy .allowedList .showMore"),function(){return ETConversation.id;},true);if($("#reply").length)ETConversation.initReply();$(window).bind("beforeunload.ajax",ETConversation.beforeUnload);},scrollTo:function(position){ETScrubber.scrollTo(position);},beforeUnload:function onbeforeunload(){if(ETConversation.editingPosts>0)return T("message.confirmLeave");else if(ETConversation.editingReply)return T("message.confirmDiscardReply");},replyShowing:false,initReply:function(){var textarea=$("#reply textarea");ETConversation.editingReply=false;textarea.TextAreaExpander(200,700);if(!textarea.val())$("#reply .postReply").disable();$("#reply .saveDraft").disable();textarea.keyup(function(e){if(e.ctrlKey)return;$("#reply .postReply, #reply .saveDraft")[$(this).val()?"enable":"disable"]();ETConversation.editingReply=$(this).val()?true:false;});if(ET.mentions)new ETAutoCompletePopup($("#reply textarea"),"@");$("#reply .saveDraft").click(function(e){ETConversation.saveDraft();e.preventDefault();});$("#reply .discardDraft").click(function(e){ETConversation.discardDraft();e.preventDefault();});$("#reply .postReply").click(function(e){if(ETConversation.id)ETConversation.addReply();else ETConversation.startConversation();e.preventDefault();});if(!$("#reply").hasClass("logInToReply")&&ETConversation.id){$("#reply").addClass("replyPlaceholder");$("#reply").click(function(e){if(!ETConversation.replyShowing){$(this).trigger("change");var scrollTop=$(document).scrollTop();$("#reply textarea").focus();$.scrollTo(scrollTop);$.scrollTo("#reply","slow");}
e.stopPropagation();});$("#reply").change(function(e){if(!ETConversation.replyShowing){ETConversation.replyShowing=true;$("#reply").removeClass("replyPlaceholder");var pos=textarea.val().length;textarea.selectRange(pos,pos);}});if($("#reply textarea").val())$("#reply").trigger("change");$(document).click(function(e){ETConversation.hideReply();});}
$("#reply .controls a").tooltip({alignment:"center"});textarea.keypress(function(e){if(e.ctrlKey&&e.which==13&&!$("#reply .postReply").prop("disabled")){$("#reply .postReply").click();e.preventDefault();}});},hideReply:function(){if(!ETConversation.replyShowing||$("#reply textarea").val())return;var scrollTop=$(document).scrollTop();var oldHeight=$("#reply .postContent").height();ETConversation.replyShowing=false;$("#reply").addClass("replyPlaceholder");var newHeight=$("#reply .postContent").height();$("#reply .postContent").height(oldHeight).animate({height:newHeight},"fast",function(){$(this).height("");});$.scrollTo(scrollTop);ETConversation.editingReply=false;},resetReply:function(){$("#reply textarea").val("");ETConversation.togglePreview("reply",false);ETConversation.hideReply();},addReply:function(){var content=$("#reply textarea").val();$("#reply .postReply, #reply .saveDraft").disable();$.ETAjax({url:"conversation/reply.ajax/"+ETConversation.id,type:"post",data:{conversationId:ETConversation.id,content:content},success:function(data){if(!data.postId){$("#reply .postReply, #reply .saveDraft").enable();return;}
ETMessages.hideMessage("waitToReply");ETMessages.hideMessage("emptyPost");$("#conversationHeader .labels .label-draft").remove();ETConversation.resetReply();ETConversation.postCount++;var moreItem=$("<li></li>").appendTo("#conversationPosts");ETScrubber.count=ETConversation.postCount;var items=ETScrubber.addItems(ETConversation.postCount-1,data.view,moreItem,true);ETConversation.redisplayAvatars();ETConversation.collapseQuotes(items);if(data.starOnReply){toggleStarState(ETConversation.id,true);}
ETConversation.updateInterval.reset(ET.conversationUpdateIntervalStart);},beforeSend:function(){createLoadingOverlay("reply","reply");},complete:function(){hideLoadingOverlay("reply",false);}});},startConversation:function(draft){var title=$("#conversationTitle input").val();var content=$("#reply textarea").val();var channel=$("#conversationHeader .channels :radio:checked").val();$("#reply .postReply, #reply .saveDraft").disable();var data={title:title,content:content,channel:channel};if(draft)data.saveDraft="1";$.ETAjax({url:"conversation/start.ajax",type:"post",data:data,beforeSend:function(){createLoadingOverlay("reply","reply");ETConversation.editingReply=false;},complete:function(){hideLoadingOverlay("reply",false);$("#reply .postReply, #reply .saveDraft").enable();},success:function(data){if(data.messages){if(data.messages.title)$("#conversationTitle input").focus();if(data.messages.content)$("#reply textarea").focus();return;}}});},saveDraft:function(){if(!ETConversation.id){ETConversation.startConversation(true);return;}
$.ETAjax({url:"conversation/reply.ajax/"+ETConversation.id,type:"post",data:{saveDraft:true,content:$("#reply textarea").val()},beforeSend:function(){createLoadingOverlay("reply","reply");},complete:function(){hideLoadingOverlay("reply",false);},success:function(data){if(data.messages)return;ETMessages.hideMessage("emptyPost");$("#conversationHeader .labels").html(data.labels);$("#reply .saveDraft").disable();ETConversation.editingReply=false;}});},discardDraft:function(){if(this.postCount==0&&$("#control-delete").length){if(ETConversation.confirmDelete())window.location=$("#control-delete").attr("href");return;}
$.ETAjax({url:"conversation/reply.ajax/"+ETConversation.id,type:"post",data:{discardDraft:true},beforeSend:function(){createLoadingOverlay("reply","reply");},complete:function(){hideLoadingOverlay("reply",false);},success:function(data){$("#conversationHeader .labels").html(data.labels);ETConversation.resetReply();}});},update:function(){if(ETConversation.searchString||ETScrubber.loadedItems.indexOf(ETConversation.postCount-1)==-1)return;$.ETAjax({url:"conversation/index.ajax/"+ETConversation.id+"/"+ETConversation.postCount,success:function(data){if(ETConversation.postCount<data.countPosts){ETConversation.postCount=data.countPosts;var moreItem=$("<li></li>").appendTo("#conversationPosts");ETScrubber.count=ETConversation.postCount;ETScrubber.addItems(data.startFrom,data.view,moreItem,true);var interval=ET.conversationUpdateIntervalStart;}
else var interval=Math.min(ET.conversationUpdateIntervalLimit,ETConversation.updateInterval.interval*ET.conversationUpdateIntervalMultiplier);ETConversation.updateInterval.reset(interval);},global:false});},initPosts:function(){$("#conversationPosts .controls a").tooltip({alignment:"center"});$("#conversationPosts h3 a").tooltip({alignment:"left",className:"withArrow withArrowBottom"});$("#conversationPosts .time").tooltip({alignment:"left",className:"withArrow withArrowBottom"});$("#conversationPosts .online").tooltip({alignment:"left",offset:[-9,0],className:"withArrow withArrowBottom"}).css("cursor","pointer");$("#conversationPosts .controls .control-edit").live("click",function(e){var postId=$(this).parents(".post").data("id");ETConversation.editPost(postId);e.preventDefault();});$("#conversationPosts .controls .control-delete").live("click",function(e){var postId=$(this).parents(".post").data("id");ETConversation.deletePost(postId);e.preventDefault();});$("#conversationPosts .controls .control-restore").live("click",function(e){var postId=$(this).parents(".post").data("id");ETConversation.restorePost(postId);e.preventDefault();});$("#conversationPosts .post:not(.edit) .controls .control-quote").live("click",function(e){var postId=$(this).parents(".post").data("id");ETConversation.quotePost(postId,e.shiftKey);e.preventDefault();});$("#conversationPosts .postBody a[rel=post]").live("click",function(e){var id=$(this).data("id");$("#conversationPosts .post").each(function(){if($(this).data("id")==id){ETConversation.scrollTo($(this).offset().top-10);ETConversation.highlightPost($("#p"+id));e.preventDefault();return false;}});});ETConversation.collapseQuotes($("#conversationPosts"));},collapseQuotes:function(items){$(".postBody blockquote:not(.collapsed)",items).addClass("collapsed").each(function(){if($(this)[0].scrollHeight<=$(this).innerHeight()+20){$(this).removeClass("collapsed");return;}
var link=$("<a href='#' class='expand'><i class='icon-ellipsis-horizontal'></i></a>");link.click(function(e){e.preventDefault();$(this).parents("blockquote").removeClass("collapsed");$(this).remove();});$(this).append(link);});},highlightPost:function(post){$("#conversationPosts .post.highlight").removeClass("highlight");$(post).addClass("highlight");},redisplayAvatars:function(){var prevId=null;$("#conversationPosts > li").each(function(){if(prevId==$(this).find("div.post").data("memberid"))
$(this).find("div.avatar").hide();else
$(this).find("div.avatar").show();prevId=$(this).find("div.post").data("memberid");});},deletePost:function(postId){$.hideToolTip();$.ETAjax({url:"conversation/deletePost.ajax/"+postId,beforeSend:function(){createLoadingOverlay("p"+postId,"p"+postId);},complete:function(){hideLoadingOverlay("p"+postId,true);},success:function(data){if(data.messages)return;$("#p"+postId).replaceWith(data.view);ETConversation.redisplayAvatars();}});},restorePost:function(postId){$.hideToolTip();$.ETAjax({url:"conversation/restorePost.ajax/"+postId,beforeSend:function(){createLoadingOverlay("p"+postId,"p"+postId);},complete:function(){hideLoadingOverlay("p"+postId,true);},success:function(data){if(data.messages)return;$("#p"+postId).replaceWith(data.view);ETConversation.redisplayAvatars();ETConversation.collapseQuotes($("#p"+postId));}});},editPost:function(postId){$.hideToolTip();var post=$("#p"+postId);$.ETAjax({url:"conversation/editPost.ajax/"+postId,type:"get",beforeSend:function(){createLoadingOverlay("p"+postId,"p"+postId);},complete:function(){hideLoadingOverlay("p"+postId,true);},success:function(data){if(data.messages||data.modalMessage)return;ETConversation.updateEditPost(postId,data.view);}});},updateEditPost:function(postId,html){var post=$("#p"+postId);ETConversation.editingPosts++;var startHeight=$(".postContent",post).height();post.replaceWith($(html).find(".post"));var newPost=$("#p"+postId);var textarea=$("textarea",newPost);newPost.data("oldPost",post);var len=textarea.val().length;textarea.TextAreaExpander(200,700).focus().selectRange(len,len);new ETAutoCompletePopup(textarea,"@");$(".cancel",newPost).click(function(e){e.preventDefault();ETConversation.cancelEditPost(postId);});$(".submit",newPost).click(function(e){e.preventDefault();ETConversation.saveEditPost(postId,textarea.val());});var newHeight=$(".postContent",newPost).height();$(".postContent",newPost).height(startHeight).animate({height:newHeight},"fast",function(){$(this).height("");});ETConversation.redisplayAvatars();var scrollTo=newPost.offset().top+newHeight-$(window).height()+10;if($(document).scrollTop()<scrollTo)$.scrollTo(scrollTo,"slow");textarea.keydown(function(e){if(e.ctrlKey&&e.which==13){ETConversation.saveEditPost(postId,this.value);e.preventDefault();}
if(e.which==27){ETConversation.cancelEditPost(postId);e.preventDefault();}});},saveEditPost:function(postId,content){var post=$("#p"+postId);$(".button",post).disable();$.ETAjax({url:"conversation/editPost.ajax/"+postId,type:"post",data:{content:content,save:true},beforeSend:function(){createLoadingOverlay("p"+postId,"p"+postId);},complete:function(){hideLoadingOverlay("p"+postId,true);$(".button",post).enable();},success:function(data){if(data.messages)return;var startHeight=$(".postContent",post).height();post.replaceWith(data.view);var newPost=$("#p"+postId);var newHeight=$(".postContent",newPost).height();$(".postContent",newPost).height(startHeight).animate({height:newHeight},"fast",function(){$(this).height("");});ETConversation.editingPosts--;ETConversation.redisplayAvatars();ETConversation.collapseQuotes(newPost);}});},cancelEditPost:function(postId){ETConversation.editingPosts--;var post=$("#p"+postId);var scrollTop=$(document).scrollTop();var startHeight=$(".postContent",post).height();post.replaceWith(post.data("oldPost"));var newPost=$("#p"+postId);var newHeight=$(".postContent",newPost).height();$(".postContent",newPost).height(startHeight).animate({height:newHeight},"fast",function(){$(this).height("");});$.scrollTo(scrollTop);},quotePost:function(postId,multi){var selection=""+$.getSelection();$.ETAjax({url:"conversation/quotePost.json/"+postId,success:function(data){var top=$(document).scrollTop();ETConversation.quote("reply",selection?selection:data.content,data.postId+":"+data.member,null,true);if(!multi){$("#jumpToReply").click();}else{$("#reply").change();$.scrollTo(top);}},global:true});},initMembersAllowed:function(){$("#addMemberForm .help").toggle($("#membersAllowedSheet .allowedList .name").length?true:false);var ac=new ETAutoCompletePopup($("#addMemberForm input[name=member]"),false,function(member){ETConversation.addMember(member.name);});$("#addMemberForm").wrap("<form>");$("#addMemberForm").parent().submit(function(e){ETConversation.addMember($("#addMemberForm input[name=member]").val());ac.stop();e.preventDefault();});$("#membersAllowedSheet .allowedList .name a").die("click").live("click",function(e){e.preventDefault();ETConversation.removeMember($(this).data("type"),$(this).data("id"));});$("#addMemberForm input[name=member]").focus();},changeMembersAllowed:function(){ETSheet.loadSheet("membersAllowedSheet","conversation/membersAllowed.ajax/"+ETConversation.id,function(){ETConversation.initMembersAllowed();});},addMember:function(name){if(!name)return;$.ETAjax({id:"addMember",url:"conversation/addMember.ajax/"+ETConversation.id,type:"post",data:{member:name},success:function(data){if(data.messages)$("#addMemberForm input[name=member]").select();else{$("#addMemberForm .help").show();$("#addMemberForm input[name=member]").val("");$("#conversationPrivacy .allowedList").html(data.allowedSummary);$("#membersAllowedSheet .allowedList").html(data.allowedList);$("#conversationHeader .labels").html(data.labels);ETMembersAllowedTooltip.init($("#conversationPrivacy .allowedList .showMore"),function(){return ETConversation.id;},true);}}});},removeMember:function(type,id){var data={};data[type]=id;$.ETAjax({id:"addMember",url:"conversation/removeMember.ajax/"+ETConversation.id,type:"post",data:data,success:function(data){$("#conversationPrivacy .allowedList").html(data.allowedSummary);$("#membersAllowedSheet .allowedList").html(data.allowedList);$("#addMemberForm .help").toggle($("#membersAllowedSheet .allowedList .name").length?true:false);$("#conversationHeader .labels").html(data.labels);ETMembersAllowedTooltip.init($("#conversationPrivacy .allowedList .showMore"),function(){return ETConversation.id;},true);}});},changeChannel:function(){ETSheet.loadSheet("changeChannelSheet","conversation/changeChannel.view/"+ETConversation.id,function(){$("#changeChannelSheet .channelList input").hide().click(function(){$("#changeChannelSheet form").submit();});$("#changeChannelSheet .buttons").hide();$("#changeChannelSheet .channelList li").tooltip({alignment:"left",offset:[0,35],className:"hoverable"});$("#changeChannelSheet form").submit(function(e){e.preventDefault();var channelId=$(this).find("input:checked").val();$.ETAjax({url:"conversation/save.json/"+ETConversation.id,type:"post",data:{channel:channelId},success:function(data){if(data.messages)return;$("#conversationPrivacy .allowedList").html(data.allowedSummary);ETMembersAllowedTooltip.init($("#conversationPrivacy .allowedList .showMore"),function(){return ETConversation.id;},true);ETConversation.channel=channelId;$("#conversationHeader .channels").replaceWith(data.channelPath);ETSheet.hideSheet("changeChannelSheet");}})});});},editTitle:function(){if(!$("#conversationTitle").hasClass("editing")){var title=$("#conversationTitle a").text().trim();$("#conversationTitle").html("<input type='text' class='text' maxlength='100'/>").addClass("editing");$("#conversationTitle input").val(title).autoGrowInput({comfortZone:30,minWidth:250,maxWidth:500}).trigger("update");$("#conversationTitle input").select().blur(function(){ETConversation.saveTitle();}).keydown(function(e){if(e.which==13)ETConversation.saveTitle();if(e.which==27)ETConversation.saveTitle(true);});}},saveTitle:function(cancel){if($("#conversationTitle").hasClass("editing")){var title=$("#conversationTitle input").val();if(!title||cancel)title=ETConversation.title;var sanitized=$('<div/>').text(title).html();$("#conversationTitle").html("<a href='#'>"+sanitized+"</a>").removeClass("editing");if(cancel||ETConversation.title==title)return;$(document).attr("title",$(document).attr("title").replace(ETConversation.title,title));ETConversation.title=title;$.ETAjax({url:"conversation/save.json/"+ETConversation.id,type:"post",data:{title:title},global:true});}},toggleSticky:function(){$("#control-sticky span").html(T($("#control-sticky span").html()==T("Sticky")?"Unsticky":"Sticky"));$.ETAjax({url:"conversation/sticky.ajax/"+ETConversation.id,success:function(data){$("#conversationHeader .labels").html(data.labels);}});},toggleLock:function(){$("#control-lock span").html(T($("#control-lock span").html()==T("Lock")?"Unlock":"Lock"));$.ETAjax({url:"conversation/lock.ajax/"+ETConversation.id,success:function(data){$("#conversationHeader .labels").html(data.labels);}});},toggleMute:function(){$("#control-mute span").html(T($("#control-mute span").html()==T("Mute conversation")?"Unmute conversation":"Mute conversation"));$.ETAjax({url:"conversation/mute.ajax/"+ETConversation.id,success:function(data){$("#conversationHeader .labels").html(data.labels);}});},confirmDelete:function(){return confirm(T("message.confirmDelete"));},quote:function(id,quote,name,postId,insert){var argument=postId||name?(postId?postId+":":"")+(name?name:"Name"):"";var startTag="[quote"+(argument?"="+argument:"")+"]"+(quote?quote:"");var endTag="[/quote]";if(insert)ETConversation.insertText($("#"+id+" textarea"),startTag+endTag+"\n");else ETConversation.wrapText($("#"+id+" textarea"),startTag,endTag);},insertText:function(textarea,text){textarea=$(textarea);textarea.focus();textarea.val(textarea.val()+text);textarea.focus();textarea.trigger("keyup");},wrapText:function(textarea,tagStart,tagEnd,selectArgument,defaultArgumentValue){textarea=$(textarea);var scrollTop=textarea.scrollTop();var selectionInfo=textarea.getSelection();if(textarea.val().substring(selectionInfo.start,selectionInfo.start+1).match(/ /))selectionInfo.start++;if(textarea.val().substring(selectionInfo.end-1,selectionInfo.end).match(/ /))selectionInfo.end--;var selection=textarea.val().substring(selectionInfo.start,selectionInfo.end);selection=selection?selection:(defaultArgumentValue?defaultArgumentValue:"");var text=tagStart+selection+(typeof tagEnd!="undefined"?tagEnd:tagStart);textarea.val(textarea.val().substr(0,selectionInfo.start)+text+textarea.val().substr(selectionInfo.end));textarea.scrollTo(scrollTop);textarea.focus();if(selectArgument){var newStart=selectionInfo.start+tagStart.indexOf(selectArgument);var newEnd=newStart+selectArgument.length;}else{var newStart=selectionInfo.start+tagStart.length;var newEnd=newStart+selection.length;}
textarea.selectRange(newStart,newEnd);textarea.trigger("keyup");},togglePreview:function(id,preview){if(preview){$("#"+id+" .formattingButtons").hide();$("#"+id+"-preview").html("");$.ETAjax({url:"conversation/preview.ajax",type:"post",data:{content:$("#"+id+" textarea").val()},success:function(data){$("#"+id+"-preview").css("min-height",$("#"+id+"-textarea").innerHeight());$("#"+id+" textarea").hide();$("#"+id+"-preview").show()
$("#"+id+"-preview").html(data.content);}});}
else{$("#"+id+" .formattingButtons").show();$("#"+id+" textarea").show();$("#"+id+"-preview").hide();}}};$(function(){ETConversation.init();});var BBCode={punane:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[r]","[/r]");},bold:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[b]","[/b]");},italic:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[i]","[/i]");},strikethrough:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[s]","[/s]");},header:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[h]","[/h]");},link:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[url=http://example.com]","[/url]","http://example.com","link text");},image:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[img]","[/img]","","http://example.com/image.jpg");},fixed:function(id){ETConversation.wrapText($("#"+id+" textarea"),"[code]","[/code]");},};var qq=function(element){"use strict";return{hide:function(){element.style.display='none';return this;},attach:function(type,fn){if(element.addEventListener){element.addEventListener(type,fn,false);}else if(element.attachEvent){element.attachEvent('on'+type,fn);}
return function(){qq(element).detach(type,fn);};},detach:function(type,fn){if(element.removeEventListener){element.removeEventListener(type,fn,false);}else if(element.attachEvent){element.detachEvent('on'+type,fn);}
return this;},contains:function(descendant){if(element===descendant){return true;}
if(element.contains){return element.contains(descendant);}else{return!!(descendant.compareDocumentPosition(element)&8);}},insertBefore:function(elementB){elementB.parentNode.insertBefore(element,elementB);return this;},remove:function(){element.parentNode.removeChild(element);return this;},css:function(styles){if(styles.opacity!==null){if(typeof element.style.opacity!=='string'&&typeof(element.filters)!=='undefined'){styles.filter='alpha(opacity='+Math.round(100*styles.opacity)+')';}}
qq.extend(element.style,styles);return this;},hasClass:function(name){var re=new RegExp('(^| )'+name+'( |$)');return re.test(element.className);},addClass:function(name){if(!qq(element).hasClass(name)){element.className+=' '+name;}
return this;},removeClass:function(name){var re=new RegExp('(^| )'+name+'( |$)');element.className=element.className.replace(re,' ').replace(/^\s+|\s+$/g,"");return this;},getByClass:function(className){var candidates,result=[];if(element.querySelectorAll){return element.querySelectorAll('.'+className);}
candidates=element.getElementsByTagName("*");qq.each(candidates,function(idx,val){if(qq(val).hasClass(className)){result.push(val);}});return result;},children:function(){var children=[],child=element.firstChild;while(child){if(child.nodeType===1){children.push(child);}
child=child.nextSibling;}
return children;},setText:function(text){element.innerText=text;element.textContent=text;return this;},clearText:function(){return qq(element).setText("");}};};qq.log=function(message,level){"use strict";if(window.console){if(!level||level==='info'){window.console.log(message);}
else
{if(window.console[level]){window.console[level](message);}
else{window.console.log('<'+level+'> '+message);}}}};qq.isObject=function(variable){"use strict";return variable!==null&&variable&&typeof(variable)==="object"&&variable.constructor===Object;};qq.isFunction=function(variable){"use strict";return typeof(variable)==="function";};qq.isString=function(maybeString){"use strict";return Object.prototype.toString.call(maybeString)==='[object String]';};qq.trimStr=function(string){if(String.prototype.trim){return string.trim();}
return string.replace(/^\s+|\s+$/g,'');};qq.isFileOrInput=function(maybeFileOrInput){"use strict";if(window.File&&maybeFileOrInput instanceof File){return true;}
else if(window.HTMLInputElement){if(maybeFileOrInput instanceof HTMLInputElement){if(maybeFileOrInput.type&&maybeFileOrInput.type.toLowerCase()==='file'){return true;}}}
else if(maybeFileOrInput.tagName){if(maybeFileOrInput.tagName.toLowerCase()==='input'){if(maybeFileOrInput.type&&maybeFileOrInput.type.toLowerCase()==='file'){return true;}}}
return false;};qq.isBlob=function(maybeBlob){"use strict";return window.Blob&&Object.prototype.toString.call(maybeBlob)==='[object Blob]';};qq.isXhrUploadSupported=function(){"use strict";var input=document.createElement('input');input.type='file';return(input.multiple!==undefined&&typeof File!=="undefined"&&typeof FormData!=="undefined"&&typeof(new XMLHttpRequest()).upload!=="undefined");};qq.isFolderDropSupported=function(dataTransfer){"use strict";return(dataTransfer.items&&dataTransfer.items[0].webkitGetAsEntry);};qq.isFileChunkingSupported=function(){"use strict";return!qq.android()&&qq.isXhrUploadSupported()&&(File.prototype.slice!==undefined||File.prototype.webkitSlice!==undefined||File.prototype.mozSlice!==undefined);};qq.extend=function(first,second,extendNested){"use strict";qq.each(second,function(prop,val){if(extendNested&&qq.isObject(val)){if(first[prop]===undefined){first[prop]={};}
qq.extend(first[prop],val,true);}
else{first[prop]=val;}});};qq.indexOf=function(arr,elt,from){"use strict";if(arr.indexOf){return arr.indexOf(elt,from);}
from=from||0;var len=arr.length;if(from<0){from+=len;}
for(;from<len;from+=1){if(arr.hasOwnProperty(from)&&arr[from]===elt){return from;}}
return-1;};qq.getUniqueId=function(){"use strict";return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});};qq.ie=function(){"use strict";return navigator.userAgent.indexOf('MSIE')!==-1;};qq.ie10=function(){"use strict";return navigator.userAgent.indexOf('MSIE 10')!==-1;};qq.safari=function(){"use strict";return navigator.vendor!==undefined&&navigator.vendor.indexOf("Apple")!==-1;};qq.chrome=function(){"use strict";return navigator.vendor!==undefined&&navigator.vendor.indexOf('Google')!==-1;};qq.firefox=function(){"use strict";return(navigator.userAgent.indexOf('Mozilla')!==-1&&navigator.vendor!==undefined&&navigator.vendor==='');};qq.windows=function(){"use strict";return navigator.platform==="Win32";};qq.android=function(){"use strict";return navigator.userAgent.toLowerCase().indexOf('android')!==-1;};qq.preventDefault=function(e){"use strict";if(e.preventDefault){e.preventDefault();}else{e.returnValue=false;}};qq.toElement=(function(){"use strict";var div=document.createElement('div');return function(html){div.innerHTML=html;var element=div.firstChild;div.removeChild(element);return element;};}());qq.each=function(obj,callback){"use strict";var key,retVal;if(obj){for(key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){retVal=callback(key,obj[key]);if(retVal===false){break;}}}}};qq.obj2url=function(obj,temp,prefixDone){"use strict";var i,len,uristrings=[],prefix='&',add=function(nextObj,i){var nextTemp=temp?(/\[\]$/.test(temp))?temp:temp+'['+i+']':i;if((nextTemp!=='undefined')&&(i!=='undefined')){uristrings.push((typeof nextObj==='object')?qq.obj2url(nextObj,nextTemp,true):(Object.prototype.toString.call(nextObj)==='[object Function]')?encodeURIComponent(nextTemp)+'='+encodeURIComponent(nextObj()):encodeURIComponent(nextTemp)+'='+encodeURIComponent(nextObj));}};if(!prefixDone&&temp){prefix=(/\?/.test(temp))?(/\?$/.test(temp))?'':'&':'?';uristrings.push(temp);uristrings.push(qq.obj2url(obj));}else if((Object.prototype.toString.call(obj)==='[object Array]')&&(typeof obj!=='undefined')){for(i=-1,len=obj.length;i<len;i+=1){add(obj[i],i);}}else if((typeof obj!=='undefined')&&(obj!==null)&&(typeof obj==="object")){for(i in obj){if(obj.hasOwnProperty(i)){add(obj[i],i);}}}else{uristrings.push(encodeURIComponent(temp)+'='+encodeURIComponent(obj));}
if(temp){return uristrings.join(prefix);}else{return uristrings.join(prefix).replace(/^&/,'').replace(/%20/g,'+');}};qq.obj2FormData=function(obj,formData,arrayKeyName){"use strict";if(!formData){formData=new FormData();}
qq.each(obj,function(key,val){key=arrayKeyName?arrayKeyName+'['+key+']':key;if(qq.isObject(val)){qq.obj2FormData(val,formData,key);}
else if(qq.isFunction(val)){formData.append(key,val());}
else{formData.append(key,val);}});return formData;};qq.obj2Inputs=function(obj,form){"use strict";var input;if(!form){form=document.createElement('form');}
qq.obj2FormData(obj,{append:function(key,val){input=document.createElement('input');input.setAttribute('name',key);input.setAttribute('value',val);form.appendChild(input);}});return form;};qq.setCookie=function(name,value,days){var date=new Date(),expires="";if(days){date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();}
document.cookie=name+"="+value+expires+"; path=/";};qq.getCookie=function(name){var nameEQ=name+"=",ca=document.cookie.split(';'),c;for(var i=0;i<ca.length;i++){c=ca[i];while(c.charAt(0)==' '){c=c.substring(1,c.length);}
if(c.indexOf(nameEQ)===0){return c.substring(nameEQ.length,c.length);}}};qq.getCookieNames=function(regexp){var cookies=document.cookie.split(';'),cookieNames=[];qq.each(cookies,function(idx,cookie){cookie=qq.trimStr(cookie);var equalsIdx=cookie.indexOf("=");if(cookie.match(regexp)){cookieNames.push(cookie.substr(0,equalsIdx));}});return cookieNames;};qq.deleteCookie=function(name){qq.setCookie(name,"",-1);};qq.areCookiesEnabled=function(){var randNum=Math.random()*100000,name="qqCookieTest:"+randNum;qq.setCookie(name,1);if(qq.getCookie(name)){qq.deleteCookie(name);return true;}
return false;};qq.parseJson=function(json){if(window.JSON&&qq.isFunction(JSON.parse)){return JSON.parse(json);}else{return eval("("+json+")");}};qq.DisposeSupport=function(){"use strict";var disposers=[];return{dispose:function(){var disposer;do{disposer=disposers.shift();if(disposer){disposer();}}
while(disposer);},attach:function(){var args=arguments;this.addDisposer(qq(args[0]).attach.apply(this,Array.prototype.slice.call(arguments,1)));},addDisposer:function(disposeFunction){disposers.push(disposeFunction);}};};qq.supportedFeatures=(function(){var supportsUploading,supportsAjaxFileUploading,supportsFolderDrop,supportsChunking,supportsResume,supportsUploadViaPaste,supportsUploadCors,supportsDeleteFileCors;function testSupportsFileInputElement(){var supported=true,tempInput;try{tempInput=document.createElement('input');tempInput.type='file';qq(tempInput).hide();if(tempInput.disabled){supported=false;}}
catch(ex){supported=false;}
return supported;}
function isChrome21OrHigher(){return qq.chrome()&&navigator.userAgent.match(/Chrome\/[2][1-9]|Chrome\/[3-9][0-9]/)!==undefined;}
function isChrome14OrHigher(){return qq.chrome()&&navigator.userAgent.match(/Chrome\/[1][4-9]|Chrome\/[2-9][0-9]/)!==undefined;}
supportsUploading=testSupportsFileInputElement();supportsAjaxFileUploading=supportsUploading&&qq.isXhrUploadSupported();supportsFolderDrop=supportsAjaxFileUploading&&isChrome21OrHigher();supportsChunking=supportsAjaxFileUploading&&qq.isFileChunkingSupported();supportsResume=supportsAjaxFileUploading&&supportsChunking&&qq.areCookiesEnabled();supportsUploadViaPaste=supportsAjaxFileUploading&&isChrome14OrHigher();supportsUploadCors=supportsUploading&&(window.postMessage!==undefined||supportsAjaxFileUploading);supportsDeleteFileCors=supportsAjaxFileUploading;return{uploading:supportsUploading,ajaxUploading:supportsAjaxFileUploading,fileDrop:supportsAjaxFileUploading,folderDrop:supportsFolderDrop,chunking:supportsChunking,resume:supportsResume,uploadCustomHeaders:supportsAjaxFileUploading,uploadNonMultipart:supportsAjaxFileUploading,itemSizeValidation:supportsAjaxFileUploading,uploadViaPaste:supportsUploadViaPaste,progressBar:supportsAjaxFileUploading,uploadCors:supportsUploadCors,deleteFileCors:supportsDeleteFileCors}}());qq.Promise=function(){"use strict";var successValue,failureValue,successCallback,failureCallback,doneCallback,state=0;return{then:function(onSuccess,onFailure){if(state===0){successCallback=onSuccess;failureCallback=onFailure;}
else if(state===-1&&onFailure){onFailure(failureValue);}
else if(onSuccess){onSuccess(successValue);}
return this;},done:function(callback){if(state===0){doneCallback=callback;}
else{callback();}
return this;},success:function(val){state=1;successValue=val;if(successCallback){successCallback(val);}
if(doneCallback){doneCallback();}
return this;},failure:function(val){state=-1;failureValue=val;if(failureCallback){failureCallback(val);}
if(doneCallback){doneCallback();}
return this;}};};qq.UploadButton=function(o){"use strict";var input,disposeSupport=new qq.DisposeSupport(),options={element:null,multiple:false,acceptFiles:null,name:'file',onChange:function(input){},hoverClass:'qq-upload-button-hover',focusClass:'qq-upload-button-focus'};function createInput(){var input=document.createElement("input");if(options.multiple){input.setAttribute("multiple","multiple");}
if(options.acceptFiles){input.setAttribute("accept",options.acceptFiles);}
input.setAttribute("type","file");input.setAttribute("name",options.name);qq(input).css({position:'absolute',right:0,top:0,fontFamily:'Arial',fontSize:'118px',margin:0,padding:0,cursor:'pointer',opacity:0});options.element.appendChild(input);disposeSupport.attach(input,'change',function(){options.onChange(input);});disposeSupport.attach(input,'mouseover',function(){qq(options.element).addClass(options.hoverClass);});disposeSupport.attach(input,'mouseout',function(){qq(options.element).removeClass(options.hoverClass);});disposeSupport.attach(input,'focus',function(){qq(options.element).addClass(options.focusClass);});disposeSupport.attach(input,'blur',function(){qq(options.element).removeClass(options.focusClass);});if(window.attachEvent){input.setAttribute('tabIndex',"-1");}
return input;}
qq.extend(options,o);qq(options.element).css({position:'relative',overflow:'hidden',direction:'ltr'});input=createInput();return{getInput:function(){return input;},reset:function(){if(input.parentNode){qq(input).remove();}
qq(options.element).removeClass(options.focusClass);input=createInput();}};};qq.PasteSupport=function(o){"use strict";var options,detachPasteHandler;options={targetElement:null,callbacks:{log:function(message,level){},pasteReceived:function(blob){}}};function isImage(item){return item.type&&item.type.indexOf("image/")===0;}
function registerPasteHandler(){qq(options.targetElement).attach("paste",function(event){var clipboardData=event.clipboardData;if(clipboardData){qq.each(clipboardData.items,function(idx,item){if(isImage(item)){var blob=item.getAsFile();options.callbacks.pasteReceived(blob);}});}});}
function unregisterPasteHandler(){if(detachPasteHandler){detachPasteHandler();}}
qq.extend(options,o);registerPasteHandler();return{reset:function(){unregisterPasteHandler();}};};qq.FineUploaderBasic=function(o){var that=this;this._options={debug:false,button:null,multiple:true,maxConnections:3,disableCancelForFormUploads:false,autoUpload:true,request:{endpoint:'/server/upload',params:{},paramsInBody:true,customHeaders:{},forceMultipart:true,inputName:'qqfile',uuidName:'qquuid',totalFileSizeName:'qqtotalfilesize'},validation:{allowedExtensions:[],sizeLimit:0,minSizeLimit:0,itemLimit:0,stopOnFirstInvalidFile:true},callbacks:{onSubmit:function(id,name){},onSubmitted:function(id,name){},onComplete:function(id,name,responseJSON,maybeXhr){},onCancel:function(id,name){},onUpload:function(id,name){},onUploadChunk:function(id,name,chunkData){},onResume:function(id,fileName,chunkData){},onProgress:function(id,name,loaded,total){},onError:function(id,name,reason,maybeXhr){},onAutoRetry:function(id,name,attemptNumber){},onManualRetry:function(id,name){},onValidateBatch:function(fileOrBlobData){},onValidate:function(fileOrBlobData){},onSubmitDelete:function(id){},onDelete:function(id){},onDeleteComplete:function(id,xhr,isError){},onPasteReceived:function(blob){}},messages:{typeError:"{file} has an invalid extension. Valid extension(s): {extensions}.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",noFilesError:"No files to upload.",tooManyItemsError:"Too many items ({netItems}) would be uploaded.  Item limit is {itemLimit}.",retryFailTooManyItems:"Retry failed - you have reached your file limit.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},retry:{enableAuto:false,maxAutoAttempts:3,autoAttemptDelay:5,preventRetryResponseProperty:'preventRetry'},classes:{buttonHover:'qq-upload-button-hover',buttonFocus:'qq-upload-button-focus'},chunking:{enabled:false,partSize:2000000,paramNames:{partIndex:'qqpartindex',partByteOffset:'qqpartbyteoffset',chunkSize:'qqchunksize',totalFileSize:'qqtotalfilesize',totalParts:'qqtotalparts',filename:'qqfilename'}},resume:{enabled:false,id:null,cookiesExpireIn:7,paramNames:{resuming:"qqresume"}},formatFileName:function(fileOrBlobName){if(fileOrBlobName.length>33){fileOrBlobName=fileOrBlobName.slice(0,19)+'...'+fileOrBlobName.slice(-14);}
return fileOrBlobName;},text:{defaultResponseError:"Upload failure reason unknown",sizeSymbols:['kB','MB','GB','TB','PB','EB']},deleteFile:{enabled:false,endpoint:'/server/upload',customHeaders:{},params:{}},cors:{expected:false,sendCredentials:false},blobs:{defaultName:'misc_data',paramNames:{name:'qqblobname'}},paste:{targetElement:null,defaultName:'pasted_image'}};qq.extend(this._options,o,true);this._wrapCallbacks();this._disposeSupport=new qq.DisposeSupport();this._filesInProgress=[];this._storedIds=[];this._autoRetries=[];this._retryTimeouts=[];this._preventRetries=[];this._netUploadedOrQueued=0;this._netUploaded=0;this._paramsStore=this._createParamsStore("request");this._deleteFileParamsStore=this._createParamsStore("deleteFile");this._endpointStore=this._createEndpointStore("request");this._deleteFileEndpointStore=this._createEndpointStore("deleteFile");this._handler=this._createUploadHandler();this._deleteHandler=this._createDeleteHandler();if(this._options.button){this._button=this._createUploadButton(this._options.button);}
if(this._options.paste.targetElement){this._pasteHandler=this._createPasteHandler();}
this._preventLeaveInProgress();};qq.FineUploaderBasic.prototype={log:function(str,level){if(this._options.debug&&(!level||level==='info')){qq.log('[FineUploader] '+str);}
else if(level&&level!=='info'){qq.log('[FineUploader] '+str,level);}},setParams:function(params,id){if(id==null){this._options.request.params=params;}
else{this._paramsStore.setParams(params,id);}},setDeleteFileParams:function(params,id){if(id==null){this._options.deleteFile.params=params;}
else{this._deleteFileParamsStore.setParams(params,id);}},setEndpoint:function(endpoint,id){if(id==null){this._options.request.endpoint=endpoint;}
else{this._endpointStore.setEndpoint(endpoint,id);}},getInProgress:function(){return this._filesInProgress.length;},getNetUploads:function(){return this._netUploaded;},uploadStoredFiles:function(){"use strict";var idToUpload;while(this._storedIds.length){idToUpload=this._storedIds.shift();this._filesInProgress.push(idToUpload);this._handler.upload(idToUpload);}},clearStoredFiles:function(){this._storedIds=[];},retry:function(id){if(this._onBeforeManualRetry(id)){this._netUploadedOrQueued++;this._handler.retry(id);return true;}
else{return false;}},cancel:function(id){this._handler.cancel(id);},cancelAll:function(){var storedIdsCopy=[],self=this;qq.extend(storedIdsCopy,this._storedIds);qq.each(storedIdsCopy,function(idx,storedFileId){self.cancel(storedFileId);});this._handler.cancelAll();},reset:function(){this.log("Resetting uploader...");this._handler.reset();this._filesInProgress=[];this._storedIds=[];this._autoRetries=[];this._retryTimeouts=[];this._preventRetries=[];this._button.reset();this._paramsStore.reset();this._endpointStore.reset();this._netUploadedOrQueued=0;this._netUploaded=0;if(this._pasteHandler){this._pasteHandler.reset();}},addFiles:function(filesDataOrInputs,params,endpoint){var self=this,verifiedFilesOrInputs=[],index,fileOrInput;if(filesDataOrInputs){if(!window.FileList||!(filesDataOrInputs instanceof FileList)){filesDataOrInputs=[].concat(filesDataOrInputs);}
for(index=0;index<filesDataOrInputs.length;index+=1){fileOrInput=filesDataOrInputs[index];if(qq.isFileOrInput(fileOrInput)){verifiedFilesOrInputs.push(fileOrInput);}
else{self.log(fileOrInput+' is not a File or INPUT element!  Ignoring!','warn');}}
this.log('Processing '+verifiedFilesOrInputs.length+' files or inputs...');this._uploadFileOrBlobDataList(verifiedFilesOrInputs,params,endpoint);}},addBlobs:function(blobDataOrArray,params,endpoint){if(blobDataOrArray){var blobDataArray=[].concat(blobDataOrArray),verifiedBlobDataList=[],self=this;qq.each(blobDataArray,function(idx,blobData){if(qq.isBlob(blobData)&&!qq.isFileOrInput(blobData)){verifiedBlobDataList.push({blob:blobData,name:self._options.blobs.defaultName});}
else if(qq.isObject(blobData)&&blobData.blob&&blobData.name){verifiedBlobDataList.push(blobData);}
else{self.log("addBlobs: entry at index "+idx+" is not a Blob or a BlobData object","error");}});this._uploadFileOrBlobDataList(verifiedBlobDataList,params,endpoint);}
else{this.log("undefined or non-array parameter passed into addBlobs","error");}},getUuid:function(id){return this._handler.getUuid(id);},getResumableFilesData:function(){return this._handler.getResumableFilesData();},getSize:function(id){return this._handler.getSize(id);},getName:function(id){return this._handler.getName(id);},getFile:function(fileOrBlobId){return this._handler.getFile(fileOrBlobId);},deleteFile:function(id){this._onSubmitDelete(id);},setDeleteFileEndpoint:function(endpoint,id){if(id==null){this._options.deleteFile.endpoint=endpoint;}
else{this._deleteFileEndpointStore.setEndpoint(endpoint,id);}},_createUploadButton:function(element){var self=this;var button=new qq.UploadButton({element:element,multiple:this._options.multiple&&qq.supportedFeatures.ajaxUploading,acceptFiles:this._options.validation.acceptFiles,onChange:function(input){self._onInputChange(input);},hoverClass:this._options.classes.buttonHover,focusClass:this._options.classes.buttonFocus});this._disposeSupport.addDisposer(function(){button.dispose();});return button;},_createUploadHandler:function(){var self=this;return new qq.UploadHandler({debug:this._options.debug,forceMultipart:this._options.request.forceMultipart,maxConnections:this._options.maxConnections,customHeaders:this._options.request.customHeaders,inputName:this._options.request.inputName,uuidParamName:this._options.request.uuidName,totalFileSizeParamName:this._options.request.totalFileSizeName,cors:this._options.cors,demoMode:this._options.demoMode,paramsInBody:this._options.request.paramsInBody,paramsStore:this._paramsStore,endpointStore:this._endpointStore,chunking:this._options.chunking,resume:this._options.resume,blobs:this._options.blobs,log:function(str,level){self.log(str,level);},onProgress:function(id,name,loaded,total){self._onProgress(id,name,loaded,total);self._options.callbacks.onProgress(id,name,loaded,total);},onComplete:function(id,name,result,xhr){self._onComplete(id,name,result,xhr);self._options.callbacks.onComplete(id,name,result,xhr);},onCancel:function(id,name){self._onCancel(id,name);self._options.callbacks.onCancel(id,name);},onUpload:function(id,name){self._onUpload(id,name);self._options.callbacks.onUpload(id,name);},onUploadChunk:function(id,name,chunkData){self._options.callbacks.onUploadChunk(id,name,chunkData);},onResume:function(id,name,chunkData){return self._options.callbacks.onResume(id,name,chunkData);},onAutoRetry:function(id,name,responseJSON,xhr){self._preventRetries[id]=responseJSON[self._options.retry.preventRetryResponseProperty];if(self._shouldAutoRetry(id,name,responseJSON)){self._maybeParseAndSendUploadError(id,name,responseJSON,xhr);self._options.callbacks.onAutoRetry(id,name,self._autoRetries[id]+1);self._onBeforeAutoRetry(id,name);self._retryTimeouts[id]=setTimeout(function(){self._onAutoRetry(id,name,responseJSON)},self._options.retry.autoAttemptDelay*1000);return true;}
else{return false;}}});},_createDeleteHandler:function(){var self=this;return new qq.DeleteFileAjaxRequestor({maxConnections:this._options.maxConnections,customHeaders:this._options.deleteFile.customHeaders,paramsStore:this._deleteFileParamsStore,endpointStore:this._deleteFileEndpointStore,demoMode:this._options.demoMode,cors:this._options.cors,log:function(str,level){self.log(str,level);},onDelete:function(id){self._onDelete(id);self._options.callbacks.onDelete(id);},onDeleteComplete:function(id,xhr,isError){self._onDeleteComplete(id,xhr,isError);self._options.callbacks.onDeleteComplete(id,xhr,isError);}});},_createPasteHandler:function(){var self=this;return new qq.PasteSupport({targetElement:this._options.paste.targetElement,callbacks:{log:function(str,level){self.log(str,level);},pasteReceived:function(blob){var callback=self._options.callbacks.onPasteReceived,promise=callback(blob);if(promise&&promise.then){promise.then(function(successData){self._handlePasteSuccess(blob,successData);},function(failureData){self.log("Ignoring pasted image per paste received callback.  Reason = '"+failureData+"'");});}
else{self._handlePasteSuccess(blob);}}}});},_handlePasteSuccess:function(blob,extSuppliedName){var extension=blob.type.split("/")[1],name=extSuppliedName;if(name==null){name=this._options.paste.defaultName;}
name+='.'+extension;this.addBlobs({name:name,blob:blob});},_preventLeaveInProgress:function(){var self=this;this._disposeSupport.attach(window,'beforeunload',function(e){if(!self._filesInProgress.length){return;}
var e=e||window.event;e.returnValue=self._options.messages.onLeave;return self._options.messages.onLeave;});},_onSubmit:function(id,name){this._netUploadedOrQueued++;if(this._options.autoUpload){this._filesInProgress.push(id);}},_onProgress:function(id,name,loaded,total){},_onComplete:function(id,name,result,xhr){if(!result.success){this._netUploadedOrQueued--;}
else{this._netUploaded++;}
this._removeFromFilesInProgress(id);this._maybeParseAndSendUploadError(id,name,result,xhr);},_onCancel:function(id,name){this._netUploadedOrQueued--;this._removeFromFilesInProgress(id);clearTimeout(this._retryTimeouts[id]);var storedItemIndex=qq.indexOf(this._storedIds,id);if(!this._options.autoUpload&&storedItemIndex>=0){this._storedIds.splice(storedItemIndex,1);}},_isDeletePossible:function(){return(this._options.deleteFile.enabled&&(!this._options.cors.expected||qq.supportedFeatures.deleteFileCors));},_onSubmitDelete:function(id){if(this._isDeletePossible()){if(this._options.callbacks.onSubmitDelete(id)!==false){this._deleteHandler.sendDelete(id,this.getUuid(id));}}
else{this.log("Delete request ignored for ID "+id+", delete feature is disabled or request not possible "+"due to CORS on a user agent that does not support pre-flighting.","warn");return false;}},_onDelete:function(fileId){},_onDeleteComplete:function(id,xhr,isError){var name=this._handler.getName(id);if(isError){this.log("Delete request for '"+name+"' has failed.","error");this._options.callbacks.onError(id,name,"Delete request failed with response code "+xhr.status,xhr);}
else{this._netUploadedOrQueued--;this._netUploaded--;this.log("Delete request for '"+name+"' has succeeded.");}},_removeFromFilesInProgress:function(id){var index=qq.indexOf(this._filesInProgress,id);if(index>=0){this._filesInProgress.splice(index,1);}},_onUpload:function(id,name){},_onInputChange:function(input){if(qq.supportedFeatures.ajaxUploading){this.addFiles(input.files);}else{this.addFiles(input);}
this._button.reset();},_onBeforeAutoRetry:function(id,name){this.log("Waiting "+this._options.retry.autoAttemptDelay+" seconds before retrying "+name+"...");},_onAutoRetry:function(id,name,responseJSON){this.log("Retrying "+name+"...");this._autoRetries[id]++;this._handler.retry(id);},_shouldAutoRetry:function(id,name,responseJSON){if(!this._preventRetries[id]&&this._options.retry.enableAuto){if(this._autoRetries[id]===undefined){this._autoRetries[id]=0;}
return this._autoRetries[id]<this._options.retry.maxAutoAttempts;}
return false;},_onBeforeManualRetry:function(id){var itemLimit=this._options.validation.itemLimit;if(this._preventRetries[id]){this.log("Retries are forbidden for id "+id,'warn');return false;}
else if(this._handler.isValid(id)){var fileName=this._handler.getName(id);if(this._options.callbacks.onManualRetry(id,fileName)===false){return false;}
if(itemLimit>0&&this._netUploadedOrQueued+1>itemLimit){this._itemError("retryFailTooManyItems","");return false;}
this.log("Retrying upload for '"+fileName+"' (id: "+id+")...");this._filesInProgress.push(id);return true;}
else{this.log("'"+id+"' is not a valid file ID",'error');return false;}},_maybeParseAndSendUploadError:function(id,name,response,xhr){if(!response.success){if(xhr&&xhr.status!==200&&!response.error){this._options.callbacks.onError(id,name,"XHR returned response code "+xhr.status,xhr);}
else{var errorReason=response.error?response.error:this._options.text.defaultResponseError;this._options.callbacks.onError(id,name,errorReason,xhr);}}},_uploadFileOrBlobDataList:function(fileOrBlobDataList,params,endpoint){var index,validationDescriptors=this._getValidationDescriptors(fileOrBlobDataList),batchValid=this._isBatchValid(validationDescriptors);if(batchValid){if(fileOrBlobDataList.length>0){for(index=0;index<fileOrBlobDataList.length;index++){if(this._validateFileOrBlobData(fileOrBlobDataList[index])){this._upload(fileOrBlobDataList[index],params,endpoint);}else{if(this._options.validation.stopOnFirstInvalidFile){return;}}}}
else{this._itemError("noFilesError","");}}},_upload:function(blobOrFileContainer,params,endpoint){var id=this._handler.add(blobOrFileContainer);var name=this._handler.getName(id);if(params){this.setParams(params,id);}
if(endpoint){this.setEndpoint(endpoint,id);}
if(this._options.callbacks.onSubmit(id,name)!==false){this._onSubmit(id,name);this._options.callbacks.onSubmitted(id,name);if(this._options.autoUpload){this._handler.upload(id);}
else{this._storeForLater(id);}}},_storeForLater:function(id){this._storedIds.push(id);},_isBatchValid:function(validationDescriptors){var errorMessage,itemLimit=this._options.validation.itemLimit,proposedNetFilesUploadedOrQueued=this._netUploadedOrQueued+validationDescriptors.length,batchValid=this._options.callbacks.onValidateBatch(validationDescriptors)!==false;if(batchValid){if(itemLimit===0||proposedNetFilesUploadedOrQueued<=itemLimit){batchValid=true;}
else{batchValid=false;errorMessage=this._options.messages.tooManyItemsError.replace(/\{netItems\}/g,proposedNetFilesUploadedOrQueued).replace(/\{itemLimit\}/g,itemLimit);this._batchError(errorMessage);}}
return batchValid;},_validateFileOrBlobData:function(fileOrBlobData){var validationDescriptor,name,size;validationDescriptor=this._getValidationDescriptor(fileOrBlobData);name=validationDescriptor.name;size=validationDescriptor.size;if(this._options.callbacks.onValidate(validationDescriptor)===false){return false;}
if(qq.isFileOrInput(fileOrBlobData)&&!this._isAllowedExtension(name)){this._itemError('typeError',name);return false;}
else if(size===0){this._itemError('emptyError',name);return false;}
else if(size&&this._options.validation.sizeLimit&&size>this._options.validation.sizeLimit){this._itemError('sizeError',name);return false;}
else if(size&&size<this._options.validation.minSizeLimit){this._itemError('minSizeError',name);return false;}
return true;},_itemError:function(code,nameOrNames){var message=this._options.messages[code],allowedExtensions=[],names=[].concat(nameOrNames),name=names[0],extensionsForMessage,placeholderMatch;function r(name,replacement){message=message.replace(name,replacement);}
qq.each(this._options.validation.allowedExtensions,function(idx,allowedExtension){if(qq.isString(allowedExtension)){allowedExtensions.push(allowedExtension);}});extensionsForMessage=allowedExtensions.join(', ').toLowerCase();r('{file}',this._options.formatFileName(name));r('{extensions}',extensionsForMessage);r('{sizeLimit}',this._formatSize(this._options.validation.sizeLimit));r('{minSizeLimit}',this._formatSize(this._options.validation.minSizeLimit));placeholderMatch=message.match(/(\{\w+\})/g);if(placeholderMatch!==null){qq.each(placeholderMatch,function(idx,placeholder){r(placeholder,names[idx]);});}
this._options.callbacks.onError(null,name,message);return message;},_batchError:function(message){this._options.callbacks.onError(null,null,message);},_isAllowedExtension:function(fileName){var allowed=this._options.validation.allowedExtensions,valid=false;if(!allowed.length){return true;}
qq.each(allowed,function(idx,allowedExt){if(qq.isString(allowedExt)){var extRegex=new RegExp('\\.'+allowedExt+"$",'i');if(fileName.match(extRegex)!=null){valid=true;return false;}}});return valid;},_formatSize:function(bytes){var i=-1;do{bytes=bytes/1024;i++;}while(bytes>99);return Math.max(bytes,0.1).toFixed(1)+this._options.text.sizeSymbols[i];},_wrapCallbacks:function(){var self,safeCallback;self=this;safeCallback=function(name,callback,args){try{return callback.apply(self,args);}
catch(exception){self.log("Caught exception in '"+name+"' callback - "+exception.message,'error');}};for(var prop in this._options.callbacks){(function(){var callbackName,callbackFunc;callbackName=prop;callbackFunc=self._options.callbacks[callbackName];self._options.callbacks[callbackName]=function(){return safeCallback(callbackName,callbackFunc,arguments);};}());}},_parseFileOrBlobDataName:function(fileOrBlobData){var name;if(qq.isFileOrInput(fileOrBlobData)){if(fileOrBlobData.value){name=fileOrBlobData.value.replace(/.*(\/|\\)/,"");}else{name=(fileOrBlobData.fileName!==null&&fileOrBlobData.fileName!==undefined)?fileOrBlobData.fileName:fileOrBlobData.name;}}
else{name=fileOrBlobData.name;}
return name;},_parseFileOrBlobDataSize:function(fileOrBlobData){var size;if(qq.isFileOrInput(fileOrBlobData)){if(!fileOrBlobData.value){size=(fileOrBlobData.fileSize!==null&&fileOrBlobData.fileSize!==undefined)?fileOrBlobData.fileSize:fileOrBlobData.size;}}
else{size=fileOrBlobData.blob.size;}
return size;},_getValidationDescriptor:function(fileOrBlobData){var name,size,fileDescriptor;fileDescriptor={};name=this._parseFileOrBlobDataName(fileOrBlobData);size=this._parseFileOrBlobDataSize(fileOrBlobData);fileDescriptor.name=name;if(size!==undefined){fileDescriptor.size=size;}
return fileDescriptor;},_getValidationDescriptors:function(files){var self=this,fileDescriptors=[];qq.each(files,function(idx,file){fileDescriptors.push(self._getValidationDescriptor(file));});return fileDescriptors;},_createParamsStore:function(type){var paramsStore={},self=this;return{setParams:function(params,id){var paramsCopy={};qq.extend(paramsCopy,params);paramsStore[id]=paramsCopy;},getParams:function(id){var paramsCopy={};if(id!=null&&paramsStore[id]){qq.extend(paramsCopy,paramsStore[id]);}
else{qq.extend(paramsCopy,self._options[type].params);}
return paramsCopy;},remove:function(fileId){return delete paramsStore[fileId];},reset:function(){paramsStore={};}};},_createEndpointStore:function(type){var endpointStore={},self=this;return{setEndpoint:function(endpoint,id){endpointStore[id]=endpoint;},getEndpoint:function(id){if(id!=null&&endpointStore[id]){return endpointStore[id];}
return self._options[type].endpoint;},remove:function(fileId){return delete endpointStore[fileId];},reset:function(){endpointStore={};}};}};qq.DragAndDrop=function(o){"use strict";var options,dz,droppedFiles=[],disposeSupport=new qq.DisposeSupport();options={dropZoneElements:[],hideDropZonesBeforeEnter:false,allowMultipleItems:true,classes:{dropActive:null},callbacks:new qq.DragAndDrop.callbacks()};qq.extend(options,o,true);setupDragDrop();function uploadDroppedFiles(files){options.callbacks.dropLog('Grabbed '+files.length+" dropped files.");dz.dropDisabled(false);options.callbacks.processingDroppedFilesComplete(files);}
function traverseFileTree(entry){var dirReader,i,parseEntryPromise=new qq.Promise();if(entry.isFile){entry.file(function(file){droppedFiles.push(file);parseEntryPromise.success();},function(fileError){options.callbacks.dropLog("Problem parsing '"+entry.fullPath+"'.  FileError code "+fileError.code+".","error");parseEntryPromise.failure();});}
else if(entry.isDirectory){dirReader=entry.createReader();dirReader.readEntries(function(entries){var entriesLeft=entries.length;for(i=0;i<entries.length;i+=1){traverseFileTree(entries[i]).done(function(){entriesLeft-=1;if(entriesLeft===0){parseEntryPromise.success();}});}
if(!entries.length){parseEntryPromise.success();}},function(fileError){options.callbacks.dropLog("Problem parsing '"+entry.fullPath+"'.  FileError code "+fileError.code+".","error");parseEntryPromise.failure();});}
return parseEntryPromise;}
function handleDataTransfer(dataTransfer){var i,items,entry,pendingFolderPromises=[],handleDataTransferPromise=new qq.Promise();options.callbacks.processingDroppedFiles();dz.dropDisabled(true);if(dataTransfer.files.length>1&&!options.allowMultipleItems){options.callbacks.processingDroppedFilesComplete([]);options.callbacks.dropError('tooManyFilesError',"");dz.dropDisabled(false);handleDataTransferPromise.failure();}
else{droppedFiles=[];if(qq.isFolderDropSupported(dataTransfer)){items=dataTransfer.items;for(i=0;i<items.length;i+=1){entry=items[i].webkitGetAsEntry();if(entry){if(entry.isFile){droppedFiles.push(items[i].getAsFile());}
else{pendingFolderPromises.push(traverseFileTree(entry).done(function(){pendingFolderPromises.pop();if(pendingFolderPromises.length===0){handleDataTransferPromise.success();}}));}}}}
else{droppedFiles=dataTransfer.files;}
if(pendingFolderPromises.length===0){handleDataTransferPromise.success();}}
return handleDataTransferPromise;}
function setupDropzone(dropArea){dz=new qq.UploadDropZone({element:dropArea,onEnter:function(e){qq(dropArea).addClass(options.classes.dropActive);e.stopPropagation();},onLeaveNotDescendants:function(e){qq(dropArea).removeClass(options.classes.dropActive);},onDrop:function(e){if(options.hideDropZonesBeforeEnter){qq(dropArea).hide();}
qq(dropArea).removeClass(options.classes.dropActive);handleDataTransfer(e.dataTransfer).done(function(){uploadDroppedFiles(droppedFiles);});}});disposeSupport.addDisposer(function(){dz.dispose();});if(options.hideDropZonesBeforeEnter){qq(dropArea).hide();}}
function isFileDrag(dragEvent){var fileDrag;qq.each(dragEvent.dataTransfer.types,function(key,val){if(val==='Files'){fileDrag=true;return false;}});return fileDrag;}
function setupDragDrop(){var dropZones=options.dropZoneElements;qq.each(dropZones,function(idx,dropZone){setupDropzone(dropZone);})
if(dropZones.length&&(!qq.ie()||qq.ie10())){disposeSupport.attach(document,'dragenter',function(e){if(!dz.dropDisabled()&&isFileDrag(e)){qq.each(dropZones,function(idx,dropZone){qq(dropZone).css({display:'block'});});}});}
disposeSupport.attach(document,'dragleave',function(e){if(options.hideDropZonesBeforeEnter&&qq.FineUploader.prototype._leaving_document_out(e)){qq.each(dropZones,function(idx,dropZone){qq(dropZone).hide();});}});disposeSupport.attach(document,'drop',function(e){if(options.hideDropZonesBeforeEnter){qq.each(dropZones,function(idx,dropZone){qq(dropZone).hide();});}
e.preventDefault();});}
return{setupExtraDropzone:function(element){options.dropZoneElements.push(element);setupDropzone(element);},removeDropzone:function(element){var i,dzs=options.dropZoneElements;for(i in dzs){if(dzs[i]===element){return dzs.splice(i,1);}}},dispose:function(){disposeSupport.dispose();dz.dispose();}};};qq.DragAndDrop.callbacks=function(){return{processingDroppedFiles:function(){},processingDroppedFilesComplete:function(files){},dropError:function(code,errorSpecifics){qq.log("Drag & drop error code '"+code+" with these specifics: '"+errorSpecifics+"'","error");},dropLog:function(message,level){qq.log(message,level);}}}
qq.UploadDropZone=function(o){"use strict";var options,element,preventDrop,dropOutsideDisabled,disposeSupport=new qq.DisposeSupport();options={element:null,onEnter:function(e){},onLeave:function(e){},onLeaveNotDescendants:function(e){},onDrop:function(e){}};qq.extend(options,o);element=options.element;function dragover_should_be_canceled(){return qq.safari()||(qq.firefox()&&qq.windows());}
function disableDropOutside(e){if(!dropOutsideDisabled){if(dragover_should_be_canceled){disposeSupport.attach(document,'dragover',function(e){e.preventDefault();});}else{disposeSupport.attach(document,'dragover',function(e){if(e.dataTransfer){e.dataTransfer.dropEffect='none';e.preventDefault();}});}
dropOutsideDisabled=true;}}
function isValidFileDrag(e){if(qq.ie()&&!qq.ie10()){return false;}
var effectTest,dt=e.dataTransfer,isSafari=qq.safari();effectTest=qq.ie10()?true:dt.effectAllowed!=='none';return dt&&effectTest&&(dt.files||(!isSafari&&dt.types.contains&&dt.types.contains('Files')));}
function isOrSetDropDisabled(isDisabled){if(isDisabled!==undefined){preventDrop=isDisabled;}
return preventDrop;}
function attachEvents(){disposeSupport.attach(element,'dragover',function(e){if(!isValidFileDrag(e)){return;}
var effect=qq.ie()?null:e.dataTransfer.effectAllowed;if(effect==='move'||effect==='linkMove'){e.dataTransfer.dropEffect='move';}else{e.dataTransfer.dropEffect='copy';}
e.stopPropagation();e.preventDefault();});disposeSupport.attach(element,'dragenter',function(e){if(!isOrSetDropDisabled()){if(!isValidFileDrag(e)){return;}
options.onEnter(e);}});disposeSupport.attach(element,'dragleave',function(e){if(!isValidFileDrag(e)){return;}
options.onLeave(e);var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(qq(this).contains(relatedTarget)){return;}
options.onLeaveNotDescendants(e);});disposeSupport.attach(element,'drop',function(e){if(!isOrSetDropDisabled()){if(!isValidFileDrag(e)){return;}
e.preventDefault();options.onDrop(e);}});}
disableDropOutside();attachEvents();return{dropDisabled:function(isDisabled){return isOrSetDropDisabled(isDisabled);},dispose:function(){disposeSupport.dispose();}};};qq.FineUploader=function(o){qq.FineUploaderBasic.apply(this,arguments);qq.extend(this._options,{element:null,listElement:null,dragAndDrop:{extraDropzones:[],hideDropzones:true,disableDefaultDropzone:false},text:{uploadButton:'Upload a file',cancelButton:'Cancel',retryButton:'Retry',deleteButton:'Delete',failUpload:'Upload failed',dragZone:'Drop files here to upload',dropProcessing:'Processing dropped files...',formatProgress:"{percent}% of {total_size}",waitingForResponse:"Processing..."},template:'<div class="qq-uploader">'+
((!this._options.dragAndDrop||!this._options.dragAndDrop.disableDefaultDropzone)?'<div class="qq-upload-drop-area"><span>{dragZoneText}</span></div>':'')+
(!this._options.button?'<div class="qq-upload-button"><div>{uploadButtonText}</div></div>':'')+'<span class="qq-drop-processing"><span>{dropProcessingText}</span><span class="qq-drop-processing-spinner"></span></span>'+
(!this._options.listElement?'<ul class="qq-upload-list"></ul>':'')+'</div>',fileTemplate:'<li>'+'<div class="qq-progress-bar"></div>'+'<span class="qq-upload-spinner"></span>'+'<span class="qq-upload-finished"></span>'+'<span class="qq-upload-file"></span>'+'<span class="qq-upload-size"></span>'+'<a class="qq-upload-cancel" href="#">{cancelButtonText}</a>'+'<a class="qq-upload-retry" href="#">{retryButtonText}</a>'+'<a class="qq-upload-delete" href="#">{deleteButtonText}</a>'+'<span class="qq-upload-status-text">{statusText}</span>'+'</li>',classes:{button:'qq-upload-button',drop:'qq-upload-drop-area',dropActive:'qq-upload-drop-area-active',list:'qq-upload-list',progressBar:'qq-progress-bar',file:'qq-upload-file',spinner:'qq-upload-spinner',finished:'qq-upload-finished',retrying:'qq-upload-retrying',retryable:'qq-upload-retryable',size:'qq-upload-size',cancel:'qq-upload-cancel',deleteButton:'qq-upload-delete',retry:'qq-upload-retry',statusText:'qq-upload-status-text',success:'qq-upload-success',fail:'qq-upload-fail',successIcon:null,failIcon:null,dropProcessing:'qq-drop-processing',dropProcessingSpinner:'qq-drop-processing-spinner'},failedUploadTextDisplay:{mode:'default',maxChars:50,responseProperty:'error',enableTooltip:true},messages:{tooManyFilesError:"You may only drop one file",unsupportedBrowser:"Unrecoverable error - this browser does not permit file uploading of any kind."},retry:{showAutoRetryNote:true,autoRetryNote:"Retrying {retryNum}/{maxAuto}...",showButton:false},deleteFile:{forceConfirm:false,confirmMessage:"Are you sure you want to delete {filename}?",deletingStatusText:"Deleting...",deletingFailedText:"Delete failed"},display:{fileSizeOnSubmit:false},paste:{promptForName:false,namePromptMessage:"Please name this image"},showMessage:function(message){setTimeout(function(){window.alert(message);},0);},showConfirm:function(message,okCallback,cancelCallback){setTimeout(function(){var result=window.confirm(message);if(result){okCallback();}
else if(cancelCallback){cancelCallback();}},0);},showPrompt:function(message,defaultValue){var promise=new qq.Promise(),retVal=window.prompt(message,defaultValue);if(retVal!=null&&qq.trimStr(retVal).length>0){promise.success(retVal);}
else{promise.failure("Undefined or invalid user-supplied value.");}
return promise;}},true);qq.extend(this._options,o,true);if(!qq.supportedFeatures.uploading||(this._options.cors.expected&&!qq.supportedFeatures.uploadCors)){this._options.element.innerHTML="<div>"+this._options.messages.unsupportedBrowser+"</div>"}
else{this._wrapCallbacks();this._options.template=this._options.template.replace(/\{dragZoneText\}/g,this._options.text.dragZone);this._options.template=this._options.template.replace(/\{uploadButtonText\}/g,this._options.text.uploadButton);this._options.template=this._options.template.replace(/\{dropProcessingText\}/g,this._options.text.dropProcessing);this._options.fileTemplate=this._options.fileTemplate.replace(/\{cancelButtonText\}/g,this._options.text.cancelButton);this._options.fileTemplate=this._options.fileTemplate.replace(/\{retryButtonText\}/g,this._options.text.retryButton);this._options.fileTemplate=this._options.fileTemplate.replace(/\{deleteButtonText\}/g,this._options.text.deleteButton);this._options.fileTemplate=this._options.fileTemplate.replace(/\{statusText\}/g,"");this._element=this._options.element;this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||this._find(this._element,'list');this._classes=this._options.classes;if(!this._button){this._button=this._createUploadButton(this._find(this._element,'button'));}
this._bindCancelAndRetryEvents();this._dnd=this._setupDragAndDrop();if(this._options.paste.targetElement&&this._options.paste.promptForName){this._setupPastePrompt();}}};qq.extend(qq.FineUploader.prototype,qq.FineUploaderBasic.prototype);qq.extend(qq.FineUploader.prototype,{clearStoredFiles:function(){qq.FineUploaderBasic.prototype.clearStoredFiles.apply(this,arguments);this._listElement.innerHTML="";},addExtraDropzone:function(element){this._dnd.setupExtraDropzone(element);},removeExtraDropzone:function(element){return this._dnd.removeDropzone(element);},getItemByFileId:function(id){var item=this._listElement.firstChild;while(item){if(item.qqFileId==id)return item;item=item.nextSibling;}},reset:function(){qq.FineUploaderBasic.prototype.reset.apply(this,arguments);this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||this._find(this._element,'list');if(!this._options.button){this._button=this._createUploadButton(this._find(this._element,'button'));}
this._bindCancelAndRetryEvents();this._dnd.dispose();this._dnd=this._setupDragAndDrop();},_removeFileItem:function(fileId){var item=this.getItemByFileId(fileId);qq(item).remove();},_setupDragAndDrop:function(){var self=this,dropProcessingEl=this._find(this._element,'dropProcessing'),dropZoneElements=this._options.dragAndDrop.extraDropzones,preventSelectFiles;preventSelectFiles=function(event){event.preventDefault();};if(!this._options.dragAndDrop.disableDefaultDropzone){dropZoneElements.push(this._find(this._options.element,'drop'));}
return new qq.DragAndDrop({dropZoneElements:dropZoneElements,hideDropZonesBeforeEnter:this._options.dragAndDrop.hideDropzones,allowMultipleItems:this._options.multiple,classes:{dropActive:this._options.classes.dropActive},callbacks:{processingDroppedFiles:function(){var input=self._button.getInput();qq(dropProcessingEl).css({display:'block'});qq(input).attach('click',preventSelectFiles);},processingDroppedFilesComplete:function(files){var input=self._button.getInput();qq(dropProcessingEl).hide();qq(input).detach('click',preventSelectFiles);if(files){self.addFiles(files);}},dropError:function(code,errorData){self._itemError(code,errorData);},dropLog:function(message,level){self.log(message,level);}}});},_leaving_document_out:function(e){return((qq.chrome()||(qq.safari()&&qq.windows()))&&e.clientX==0&&e.clientY==0)||(qq.firefox()&&!e.relatedTarget);},_storeForLater:function(id){qq.FineUploaderBasic.prototype._storeForLater.apply(this,arguments);var item=this.getItemByFileId(id);qq(this._find(item,'spinner')).hide();},_find:function(parent,type){var element=qq(parent).getByClass(this._options.classes[type])[0];if(!element){throw new Error('element not found '+type);}
return element;},_onSubmit:function(id,name){qq.FineUploaderBasic.prototype._onSubmit.apply(this,arguments);this._addToList(id,name);},_onProgress:function(id,name,loaded,total){qq.FineUploaderBasic.prototype._onProgress.apply(this,arguments);var item,progressBar,percent,cancelLink;item=this.getItemByFileId(id);progressBar=this._find(item,'progressBar');percent=Math.round(loaded/total*100);if(loaded===total){cancelLink=this._find(item,'cancel');qq(cancelLink).hide();qq(progressBar).hide();qq(this._find(item,'statusText')).setText(this._options.text.waitingForResponse);this._displayFileSize(id);}
else{this._displayFileSize(id,loaded,total);qq(progressBar).css({display:'block'});}
qq(progressBar).css({width:percent+'%'});},_onComplete:function(id,name,result,xhr){qq.FineUploaderBasic.prototype._onComplete.apply(this,arguments);var item=this.getItemByFileId(id);qq(this._find(item,'statusText')).clearText();qq(item).removeClass(this._classes.retrying);qq(this._find(item,'progressBar')).hide();if(!this._options.disableCancelForFormUploads||qq.supportedFeatures.ajaxUploading){qq(this._find(item,'cancel')).hide();}
qq(this._find(item,'spinner')).hide();if(result.success){if(this._isDeletePossible()){this._showDeleteLink(id);}
qq(item).addClass(this._classes.success);if(this._classes.successIcon){this._find(item,'finished').style.display="inline-block";qq(item).addClass(this._classes.successIcon);}}else{qq(item).addClass(this._classes.fail);if(this._classes.failIcon){this._find(item,'finished').style.display="inline-block";qq(item).addClass(this._classes.failIcon);}
if(this._options.retry.showButton&&!this._preventRetries[id]){qq(item).addClass(this._classes.retryable);}
this._controlFailureTextDisplay(item,result);}},_onUpload:function(id,name){qq.FineUploaderBasic.prototype._onUpload.apply(this,arguments);this._showSpinner(id);},_onCancel:function(id,name){qq.FineUploaderBasic.prototype._onCancel.apply(this,arguments);this._removeFileItem(id);},_onBeforeAutoRetry:function(id){var item,progressBar,failTextEl,retryNumForDisplay,maxAuto,retryNote;qq.FineUploaderBasic.prototype._onBeforeAutoRetry.apply(this,arguments);item=this.getItemByFileId(id);progressBar=this._find(item,'progressBar');this._showCancelLink(item);progressBar.style.width=0;qq(progressBar).hide();if(this._options.retry.showAutoRetryNote){failTextEl=this._find(item,'statusText');retryNumForDisplay=this._autoRetries[id]+1;maxAuto=this._options.retry.maxAutoAttempts;retryNote=this._options.retry.autoRetryNote.replace(/\{retryNum\}/g,retryNumForDisplay);retryNote=retryNote.replace(/\{maxAuto\}/g,maxAuto);qq(failTextEl).setText(retryNote);if(retryNumForDisplay===1){qq(item).addClass(this._classes.retrying);}}},_onBeforeManualRetry:function(id){var item=this.getItemByFileId(id);if(qq.FineUploaderBasic.prototype._onBeforeManualRetry.apply(this,arguments)){this._find(item,'progressBar').style.width=0;qq(item).removeClass(this._classes.fail);qq(this._find(item,'statusText')).clearText();this._showSpinner(id);this._showCancelLink(item);return true;}
else{qq(item).addClass(this._classes.retryable);return false;}},_onSubmitDelete:function(id){if(this._isDeletePossible()){if(this._options.callbacks.onSubmitDelete(id)!==false){if(this._options.deleteFile.forceConfirm){this._showDeleteConfirm(id);}
else{this._sendDeleteRequest(id);}}}
else{this.log("Delete request ignored for file ID "+id+", delete feature is disabled.","warn");return false;}},_onDeleteComplete:function(id,xhr,isError){qq.FineUploaderBasic.prototype._onDeleteComplete.apply(this,arguments);var item=this.getItemByFileId(id),spinnerEl=this._find(item,'spinner'),statusTextEl=this._find(item,'statusText');qq(spinnerEl).hide();if(isError){qq(statusTextEl).setText(this._options.deleteFile.deletingFailedText);this._showDeleteLink(id);}
else{this._removeFileItem(id);}},_sendDeleteRequest:function(id){var item=this.getItemByFileId(id),deleteLink=this._find(item,'deleteButton'),statusTextEl=this._find(item,'statusText');qq(deleteLink).hide();this._showSpinner(id);qq(statusTextEl).setText(this._options.deleteFile.deletingStatusText);this._deleteHandler.sendDelete(id,this.getUuid(id));},_showDeleteConfirm:function(id){var fileName=this._handler.getName(id),confirmMessage=this._options.deleteFile.confirmMessage.replace(/\{filename\}/g,fileName),uuid=this.getUuid(id),self=this;this._options.showConfirm(confirmMessage,function(){self._sendDeleteRequest(id);});},_addToList:function(id,name){var item=qq.toElement(this._options.fileTemplate);if(this._options.disableCancelForFormUploads&&!qq.supportedFeatures.ajaxUploading){var cancelLink=this._find(item,'cancel');qq(cancelLink).remove();}
item.qqFileId=id;var fileElement=this._find(item,'file');qq(fileElement).setText(this._options.formatFileName(name));qq(this._find(item,'size')).hide();if(!this._options.multiple){this._handler.cancelAll();this._clearList();}
this._listElement.appendChild(item);if(this._options.display.fileSizeOnSubmit&&qq.supportedFeatures.ajaxUploading){this._displayFileSize(id);}},_clearList:function(){this._listElement.innerHTML='';this.clearStoredFiles();},_displayFileSize:function(id,loadedSize,totalSize){var item=this.getItemByFileId(id),size=this.getSize(id),sizeForDisplay=this._formatSize(size),sizeEl=this._find(item,'size');if(loadedSize!==undefined&&totalSize!==undefined){sizeForDisplay=this._formatProgress(loadedSize,totalSize);}
qq(sizeEl).css({display:'inline'});qq(sizeEl).setText(sizeForDisplay);},_bindCancelAndRetryEvents:function(){var self=this,list=this._listElement;this._disposeSupport.attach(list,'click',function(e){e=e||window.event;var target=e.target||e.srcElement;if(qq(target).hasClass(self._classes.cancel)||qq(target).hasClass(self._classes.retry)||qq(target).hasClass(self._classes.deleteButton)){qq.preventDefault(e);var item=target.parentNode;while(item.qqFileId===undefined){item=item.parentNode;}
if(qq(target).hasClass(self._classes.deleteButton)){self.deleteFile(item.qqFileId);}
else if(qq(target).hasClass(self._classes.cancel)){self.cancel(item.qqFileId);}
else{qq(item).removeClass(self._classes.retryable);self.retry(item.qqFileId);}}});},_formatProgress:function(uploadedSize,totalSize){var message=this._options.text.formatProgress;function r(name,replacement){message=message.replace(name,replacement);}
r('{percent}',Math.round(uploadedSize/totalSize*100));r('{total_size}',this._formatSize(totalSize));return message;},_controlFailureTextDisplay:function(item,response){var mode,maxChars,responseProperty,failureReason,shortFailureReason;mode=this._options.failedUploadTextDisplay.mode;maxChars=this._options.failedUploadTextDisplay.maxChars;responseProperty=this._options.failedUploadTextDisplay.responseProperty;if(mode==='custom'){failureReason=response[responseProperty];if(failureReason){if(failureReason.length>maxChars){shortFailureReason=failureReason.substring(0,maxChars)+'...';}}
else{failureReason=this._options.text.failUpload;this.log("'"+responseProperty+"' is not a valid property on the server response.",'warn');}
qq(this._find(item,'statusText')).setText(shortFailureReason||failureReason);if(this._options.failedUploadTextDisplay.enableTooltip){this._showTooltip(item,failureReason);}}
else if(mode==='default'){qq(this._find(item,'statusText')).setText(this._options.text.failUpload);}
else if(mode!=='none'){this.log("failedUploadTextDisplay.mode value of '"+mode+"' is not valid",'warn');}},_showTooltip:function(item,text){item.title=text;},_showSpinner:function(id){var item=this.getItemByFileId(id),spinnerEl=this._find(item,'spinner');spinnerEl.style.display="inline-block";},_showCancelLink:function(item){if(!this._options.disableCancelForFormUploads||qq.supportedFeatures.ajaxUploading){var cancelLink=this._find(item,'cancel');qq(cancelLink).css({display:'inline'});}},_showDeleteLink:function(id){var item=this.getItemByFileId(id),deleteLink=this._find(item,'deleteButton');qq(deleteLink).css({display:'inline'});},_itemError:function(code,name){var message=qq.FineUploaderBasic.prototype._itemError.apply(this,arguments);this._options.showMessage(message);},_batchError:function(message){qq.FineUploaderBasic.prototype._batchError.apply(this,arguments);this._options.showMessage(message);},_setupPastePrompt:function(){var self=this;this._options.callbacks.onPasteReceived=function(){var message=self._options.paste.namePromptMessage,defaultVal=self._options.paste.defaultName;return self._options.showPrompt(message,defaultVal);};}});qq.AjaxRequestor=function(o){"use strict";var log,shouldParamsBeInQueryString,queue=[],requestState=[],options={method:'POST',maxConnections:3,customHeaders:{},endpointStore:{},paramsStore:{},successfulResponseCodes:[200],demoMode:false,cors:{expected:false,sendCredentials:false},log:function(str,level){},onSend:function(id){},onComplete:function(id,xhr,isError){},onCancel:function(id){}};qq.extend(options,o);log=options.log;shouldParamsBeInQueryString=getMethod()==='GET'||getMethod()==='DELETE';function dequeue(id){var i=qq.indexOf(queue,id),max=options.maxConnections,nextId;delete requestState[id];queue.splice(i,1);if(queue.length>=max&&i<max){nextId=queue[max-1];sendRequest(nextId);}}
function onComplete(id){var xhr=requestState[id].xhr,method=getMethod(),isError=false;dequeue(id);if(!isResponseSuccessful(xhr.status)){isError=true;log(method+" request for "+id+" has failed - response code "+xhr.status,"error");}
options.onComplete(id,xhr,isError);}
function sendRequest(id){var xhr=new XMLHttpRequest(),method=getMethod(),params={},url;options.onSend(id);if(options.paramsStore.getParams){params=options.paramsStore.getParams(id);}
url=createUrl(id,params);requestState[id].xhr=xhr;xhr.onreadystatechange=getReadyStateChangeHandler(id);xhr.open(method,url,true);if(options.cors.expected&&options.cors.sendCredentials){xhr.withCredentials=true;}
setHeaders(id);log('Sending '+method+" request for "+id);if(!shouldParamsBeInQueryString&&params){xhr.send(qq.obj2url(params,""));}
else{xhr.send();}}
function createUrl(id,params){var endpoint=options.endpointStore.getEndpoint(id),addToPath=requestState[id].addToPath;if(addToPath!==undefined){endpoint+="/"+addToPath;}
if(shouldParamsBeInQueryString&&params){return qq.obj2url(params,endpoint);}
else{return endpoint;}}
function getReadyStateChangeHandler(id){var xhr=requestState[id].xhr;return function(){if(xhr.readyState===4){onComplete(id,xhr);}};}
function setHeaders(id){var xhr=requestState[id].xhr,customHeaders=options.customHeaders;xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("Cache-Control","no-cache");qq.each(customHeaders,function(name,val){xhr.setRequestHeader(name,val);});}
function cancelRequest(id){var xhr=requestState[id].xhr,method=getMethod();if(xhr){xhr.onreadystatechange=null;xhr.abort();dequeue(id);log('Cancelled '+method+" for "+id);options.onCancel(id);return true;}
return false;}
function isResponseSuccessful(responseCode){return qq.indexOf(options.successfulResponseCodes,responseCode)>=0;}
function getMethod(){if(options.demoMode){return"GET";}
return options.method;}
return{send:function(id,addToPath){requestState[id]={addToPath:addToPath};var len=queue.push(id);if(len<=options.maxConnections){sendRequest(id);}},cancel:function(id){return cancelRequest(id);}};};qq.DeleteFileAjaxRequestor=function(o){"use strict";var requestor,options={endpointStore:{},maxConnections:3,customHeaders:{},paramsStore:{},demoMode:false,cors:{expected:false,sendCredentials:false},log:function(str,level){},onDelete:function(id){},onDeleteComplete:function(id,xhr,isError){}};qq.extend(options,o);requestor=new qq.AjaxRequestor({method:'DELETE',endpointStore:options.endpointStore,paramsStore:options.paramsStore,maxConnections:options.maxConnections,customHeaders:options.customHeaders,successfulResponseCodes:[200,202,204],demoMode:options.demoMode,log:options.log,onSend:options.onDelete,onComplete:options.onDeleteComplete});return{sendDelete:function(id,uuid){requestor.send(id,uuid);options.log("Submitted delete file request for "+id);}};};qq.WindowReceiveMessage=function(o){var options={log:function(message,level){}},callbackWrapperDetachers={};qq.extend(options,o);return{receiveMessage:function(id,callback){var onMessageCallbackWrapper=function(event){callback(event.data);};if(window.postMessage){callbackWrapperDetachers[id]=qq(window).attach("message",onMessageCallbackWrapper);}
else{log("iframe message passing not supported in this browser!","error");}},stopReceivingMessages:function(id){if(window.postMessage){var detacher=callbackWrapperDetachers[id];if(detacher){detacher();}}}};};qq.UploadHandler=function(o){"use strict";var queue=[],options,log,dequeue,handlerImpl;options={debug:false,forceMultipart:true,paramsInBody:false,paramsStore:{},endpointStore:{},cors:{expected:false,sendCredentials:false},maxConnections:3,uuidParamName:'qquuid',totalFileSizeParamName:'qqtotalfilesize',chunking:{enabled:false,partSize:2000000,paramNames:{partIndex:'qqpartindex',partByteOffset:'qqpartbyteoffset',chunkSize:'qqchunksize',totalParts:'qqtotalparts',filename:'qqfilename'}},resume:{enabled:false,id:null,cookiesExpireIn:7,paramNames:{resuming:"qqresume"}},blobs:{paramNames:{name:'qqblobname'}},log:function(str,level){},onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,response,xhr){},onCancel:function(id,fileName){},onUpload:function(id,fileName){},onUploadChunk:function(id,fileName,chunkData){},onAutoRetry:function(id,fileName,response,xhr){},onResume:function(id,fileName,chunkData){}};qq.extend(options,o);log=options.log;dequeue=function(id){var i=qq.indexOf(queue,id),max=options.maxConnections,nextId;if(i>=0){queue.splice(i,1);if(queue.length>=max&&i<max){nextId=queue[max-1];handlerImpl.upload(nextId);}}};if(qq.supportedFeatures.ajaxUploading){handlerImpl=new qq.UploadHandlerXhr(options,dequeue,log);}
else{handlerImpl=new qq.UploadHandlerForm(options,dequeue,log);}
return{add:function(file){return handlerImpl.add(file);},upload:function(id){var len=queue.push(id);if(len<=options.maxConnections){return handlerImpl.upload(id);}},retry:function(id){var i=qq.indexOf(queue,id);if(i>=0){return handlerImpl.upload(id,true);}
else{return this.upload(id);}},cancel:function(id){log('Cancelling '+id);options.paramsStore.remove(id);handlerImpl.cancel(id);dequeue(id);},cancelAll:function(){var self=this,queueCopy=[];qq.extend(queueCopy,queue);qq.each(queueCopy,function(idx,fileId){self.cancel(fileId);});queue=[];},getName:function(id){return handlerImpl.getName(id);},getSize:function(id){if(handlerImpl.getSize){return handlerImpl.getSize(id);}},getFile:function(id){if(handlerImpl.getFile){return handlerImpl.getFile(id);}},getQueue:function(){return queue;},reset:function(){log('Resetting upload handler');queue=[];handlerImpl.reset();},getUuid:function(id){return handlerImpl.getUuid(id);},isValid:function(id){return handlerImpl.isValid(id);},getResumableFilesData:function(){if(handlerImpl.getResumableFilesData){return handlerImpl.getResumableFilesData();}
return[];}};};qq.UploadHandlerForm=function(o,uploadCompleteCallback,logCallback){"use strict";var options=o,inputs=[],uuids=[],detachLoadEvents={},postMessageCallbackTimers={},uploadComplete=uploadCompleteCallback,log=logCallback,corsMessageReceiver=new qq.WindowReceiveMessage({log:log}),onloadCallbacks={},api;function detachLoadEvent(id){if(detachLoadEvents[id]!==undefined){detachLoadEvents[id]();delete detachLoadEvents[id];}}
function registerPostMessageCallback(iframe,callback){var id=iframe.id;onloadCallbacks[uuids[id]]=callback;detachLoadEvents[id]=qq(iframe).attach('load',function(){if(inputs[id]){log("Received iframe load event for CORS upload request (file id "+id+")");postMessageCallbackTimers[id]=setTimeout(function(){var errorMessage="No valid message received from loaded iframe for file id "+id;log(errorMessage,"error");callback({error:errorMessage});},1000);}});corsMessageReceiver.receiveMessage(id,function(message){log("Received the following window message: '"+message+"'");var response=qq.parseJson(message),uuid=response.uuid,onloadCallback;if(uuid&&onloadCallbacks[uuid]){clearTimeout(postMessageCallbackTimers[id]);delete postMessageCallbackTimers[id];detachLoadEvent(id);onloadCallback=onloadCallbacks[uuid];delete onloadCallbacks[uuid];corsMessageReceiver.stopReceivingMessages(id);onloadCallback(response);}
else if(!uuid){log("'"+message+"' does not contain a UUID - ignoring.");}});}
function attachLoadEvent(iframe,callback){if(options.cors.expected){registerPostMessageCallback(iframe,callback);}
else{detachLoadEvents[iframe.id]=qq(iframe).attach('load',function(){log('Received response for '+iframe.id);if(!iframe.parentNode){return;}
try{if(iframe.contentDocument&&iframe.contentDocument.body&&iframe.contentDocument.body.innerHTML=="false"){return;}}
catch(error){log('Error when attempting to access iframe during handling of upload response ('+error+")",'error');}
callback();});}}
function getIframeContentJson(iframe){var response;try{var doc=iframe.contentDocument||iframe.contentWindow.document,innerHTML=doc.body.innerHTML;log("converting iframe's innerHTML to JSON");log("innerHTML = "+innerHTML);if(innerHTML&&innerHTML.match(/^<pre/i)){innerHTML=doc.body.firstChild.firstChild.nodeValue;}
response=qq.parseJson(innerHTML);}catch(error){log('Error when attempting to parse form upload response ('+error+")",'error');response={success:false};}
return response;}
function createIframe(id){var iframe=qq.toElement('<iframe src="javascript:false;" name="'+id+'" />');iframe.setAttribute('id',id);iframe.style.display='none';document.body.appendChild(iframe);return iframe;}
function createForm(id,iframe){var params=options.paramsStore.getParams(id),protocol=options.demoMode?"GET":"POST",form=qq.toElement('<form method="'+protocol+'" enctype="multipart/form-data"></form>'),endpoint=options.endpointStore.getEndpoint(id),url=endpoint;params[options.uuidParamName]=uuids[id];if(!options.paramsInBody){url=qq.obj2url(params,endpoint);}
else{qq.obj2Inputs(params,form);}
form.setAttribute('action',url);form.setAttribute('target',iframe.name);form.style.display='none';document.body.appendChild(form);return form;}
api={add:function(fileInput){fileInput.setAttribute('name',options.inputName);var id=inputs.push(fileInput)-1;uuids[id]=qq.getUniqueId();if(fileInput.parentNode){qq(fileInput).remove();}
return id;},getName:function(id){if(api.isValid(id)){return inputs[id].value.replace(/.*(\/|\\)/,"");}
else{log(id+" is not a valid item ID.","error");}},isValid:function(id){return inputs[id]!==undefined;},reset:function(){inputs=[];uuids=[];detachLoadEvents={};},getUuid:function(id){return uuids[id];},cancel:function(id){options.onCancel(id,this.getName(id));delete inputs[id];delete uuids[id];delete detachLoadEvents[id];if(options.cors.expected){clearTimeout(postMessageCallbackTimers[id]);delete postMessageCallbackTimers[id];corsMessageReceiver.stopReceivingMessages(id);}
var iframe=document.getElementById(id);if(iframe){iframe.setAttribute('src','java'+String.fromCharCode(115)+'cript:false;');qq(iframe).remove();}},upload:function(id){var input=inputs[id],fileName=api.getName(id),iframe=createIframe(id),form;if(!input){throw new Error('file with passed id was not added, or already uploaded or cancelled');}
options.onUpload(id,this.getName(id));form=createForm(id,iframe);form.appendChild(input);attachLoadEvent(iframe,function(responseFromMessage){log('iframe loaded');var response=responseFromMessage?responseFromMessage:getIframeContentJson(iframe);detachLoadEvent(id);if(!options.cors.expected){qq(iframe).remove();}
if(!response.success){if(options.onAutoRetry(id,fileName,response)){return;}}
options.onComplete(id,fileName,response);uploadComplete(id);});log('Sending upload request for '+id);form.submit();qq(form).remove();return id;}};return api;};qq.UploadHandlerXhr=function(o,uploadCompleteCallback,logCallback){"use strict";var options=o,uploadComplete=uploadCompleteCallback,log=logCallback,fileState=[],cookieItemDelimiter="|",chunkFiles=options.chunking.enabled&&qq.supportedFeatures.chunking,resumeEnabled=options.resume.enabled&&chunkFiles&&qq.supportedFeatures.resume,resumeId=getResumeId(),multipart=options.forceMultipart||options.paramsInBody,api;function addChunkingSpecificParams(id,params,chunkData){var size=api.getSize(id),name=api.getName(id);params[options.chunking.paramNames.partIndex]=chunkData.part;params[options.chunking.paramNames.partByteOffset]=chunkData.start;params[options.chunking.paramNames.chunkSize]=chunkData.size;params[options.chunking.paramNames.totalParts]=chunkData.count;params[options.totalFileSizeParamName]=size;if(multipart){params[options.chunking.paramNames.filename]=name;}}
function addResumeSpecificParams(params){params[options.resume.paramNames.resuming]=true;}
function getChunk(fileOrBlob,startByte,endByte){if(fileOrBlob.slice){return fileOrBlob.slice(startByte,endByte);}
else if(fileOrBlob.mozSlice){return fileOrBlob.mozSlice(startByte,endByte);}
else if(fileOrBlob.webkitSlice){return fileOrBlob.webkitSlice(startByte,endByte);}}
function getChunkData(id,chunkIndex){var chunkSize=options.chunking.partSize,fileSize=api.getSize(id),fileOrBlob=fileState[id].file||fileState[id].blobData.blob,startBytes=chunkSize*chunkIndex,endBytes=startBytes+chunkSize>=fileSize?fileSize:startBytes+chunkSize,totalChunks=getTotalChunks(id);return{part:chunkIndex,start:startBytes,end:endBytes,count:totalChunks,blob:getChunk(fileOrBlob,startBytes,endBytes),size:endBytes-startBytes};}
function getTotalChunks(id){var fileSize=api.getSize(id),chunkSize=options.chunking.partSize;return Math.ceil(fileSize/chunkSize);}
function createXhr(id){var xhr=new XMLHttpRequest();fileState[id].xhr=xhr;return xhr;}
function setParamsAndGetEntityToSend(params,xhr,fileOrBlob,id){var formData=new FormData(),method=options.demoMode?"GET":"POST",endpoint=options.endpointStore.getEndpoint(id),url=endpoint,name=api.getName(id),size=api.getSize(id),blobData=fileState[id].blobData;params[options.uuidParamName]=fileState[id].uuid;if(multipart){params[options.totalFileSizeParamName]=size;if(blobData){params[options.blobs.paramNames.name]=blobData.name;}}
if(!options.paramsInBody){if(!multipart){params[options.inputName]=name;}
url=qq.obj2url(params,endpoint);}
xhr.open(method,url,true);if(options.cors.expected&&options.cors.sendCredentials){xhr.withCredentials=true;}
if(multipart){if(options.paramsInBody){qq.obj2FormData(params,formData);}
formData.append(options.inputName,fileOrBlob);return formData;}
return fileOrBlob;}
function setHeaders(id,xhr){var extraHeaders=options.customHeaders,fileOrBlob=fileState[id].file||fileState[id].blobData.blob;xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("Cache-Control","no-cache");if(!multipart){xhr.setRequestHeader("Content-Type","application/octet-stream");xhr.setRequestHeader("X-Mime-Type",fileOrBlob.type);}
qq.each(extraHeaders,function(name,val){xhr.setRequestHeader(name,val);});}
function handleCompletedItem(id,response,xhr){var name=api.getName(id),size=api.getSize(id);fileState[id].attemptingResume=false;options.onProgress(id,name,size,size);options.onComplete(id,name,response,xhr);delete fileState[id].xhr;uploadComplete(id);}
function uploadNextChunk(id){var chunkIdx=fileState[id].remainingChunkIdxs[0],chunkData=getChunkData(id,chunkIdx),xhr=createXhr(id),size=api.getSize(id),name=api.getName(id),toSend,params;if(fileState[id].loaded===undefined){fileState[id].loaded=0;}
if(resumeEnabled&&fileState[id].file){persistChunkData(id,chunkData);}
xhr.onreadystatechange=getReadyStateChangeHandler(id,xhr);xhr.upload.onprogress=function(e){if(e.lengthComputable){var totalLoaded=e.loaded+fileState[id].loaded,estTotalRequestsSize=calcAllRequestsSizeForChunkedUpload(id,chunkIdx,e.total);options.onProgress(id,name,totalLoaded,estTotalRequestsSize);}};options.onUploadChunk(id,name,getChunkDataForCallback(chunkData));params=options.paramsStore.getParams(id);addChunkingSpecificParams(id,params,chunkData);if(fileState[id].attemptingResume){addResumeSpecificParams(params);}
toSend=setParamsAndGetEntityToSend(params,xhr,chunkData.blob,id);setHeaders(id,xhr);log('Sending chunked upload request for item '+id+": bytes "+(chunkData.start+1)+"-"+chunkData.end+" of "+size);xhr.send(toSend);}
function calcAllRequestsSizeForChunkedUpload(id,chunkIdx,requestSize){var chunkData=getChunkData(id,chunkIdx),blobSize=chunkData.size,overhead=requestSize-blobSize,size=api.getSize(id),chunkCount=chunkData.count,initialRequestOverhead=fileState[id].initialRequestOverhead,overheadDiff=overhead-initialRequestOverhead;fileState[id].lastRequestOverhead=overhead;if(chunkIdx===0){fileState[id].lastChunkIdxProgress=0;fileState[id].initialRequestOverhead=overhead;fileState[id].estTotalRequestsSize=size+(chunkCount*overhead);}
else if(fileState[id].lastChunkIdxProgress!==chunkIdx){fileState[id].lastChunkIdxProgress=chunkIdx;fileState[id].estTotalRequestsSize+=overheadDiff;}
return fileState[id].estTotalRequestsSize;}
function getLastRequestOverhead(id){if(multipart){return fileState[id].lastRequestOverhead;}
else{return 0;}}
function handleSuccessfullyCompletedChunk(id,response,xhr){var chunkIdx=fileState[id].remainingChunkIdxs.shift(),chunkData=getChunkData(id,chunkIdx);fileState[id].attemptingResume=false;fileState[id].loaded+=chunkData.size+getLastRequestOverhead(id);if(fileState[id].remainingChunkIdxs.length>0){uploadNextChunk(id);}
else{if(resumeEnabled){deletePersistedChunkData(id);}
handleCompletedItem(id,response,xhr);}}
function isErrorResponse(xhr,response){return xhr.status!==200||!response.success||response.reset;}
function parseResponse(xhr){var response;try{response=qq.parseJson(xhr.responseText);}
catch(error){log('Error when attempting to parse xhr response text ('+error+')','error');response={};}
return response;}
function handleResetResponse(id){log('Server has ordered chunking effort to be restarted on next attempt for item ID '+id,'error');if(resumeEnabled){deletePersistedChunkData(id);fileState[id].attemptingResume=false;}
fileState[id].remainingChunkIdxs=[];delete fileState[id].loaded;delete fileState[id].estTotalRequestsSize;delete fileState[id].initialRequestOverhead;}
function handleResetResponseOnResumeAttempt(id){fileState[id].attemptingResume=false;log("Server has declared that it cannot handle resume for item ID "+id+" - starting from the first chunk",'error');handleResetResponse(id);api.upload(id,true);}
function handleNonResetErrorResponse(id,response,xhr){var name=api.getName(id);if(options.onAutoRetry(id,name,response,xhr)){return;}
else{handleCompletedItem(id,response,xhr);}}
function onComplete(id,xhr){var response;if(!fileState[id]){return;}
log("xhr - server response received for "+id);log("responseText = "+xhr.responseText);response=parseResponse(xhr);if(isErrorResponse(xhr,response)){if(response.reset){handleResetResponse(id);}
if(fileState[id].attemptingResume&&response.reset){handleResetResponseOnResumeAttempt(id);}
else{handleNonResetErrorResponse(id,response,xhr);}}
else if(chunkFiles){handleSuccessfullyCompletedChunk(id,response,xhr);}
else{handleCompletedItem(id,response,xhr);}}
function getChunkDataForCallback(chunkData){return{partIndex:chunkData.part,startByte:chunkData.start+1,endByte:chunkData.end,totalParts:chunkData.count};}
function getReadyStateChangeHandler(id,xhr){return function(){if(xhr.readyState===4){onComplete(id,xhr);}};}
function persistChunkData(id,chunkData){var fileUuid=api.getUuid(id),lastByteSent=fileState[id].loaded,initialRequestOverhead=fileState[id].initialRequestOverhead,estTotalRequestsSize=fileState[id].estTotalRequestsSize,cookieName=getChunkDataCookieName(id),cookieValue=fileUuid+
cookieItemDelimiter+chunkData.part+
cookieItemDelimiter+lastByteSent+
cookieItemDelimiter+initialRequestOverhead+
cookieItemDelimiter+estTotalRequestsSize,cookieExpDays=options.resume.cookiesExpireIn;qq.setCookie(cookieName,cookieValue,cookieExpDays);}
function deletePersistedChunkData(id){if(fileState[id].file){var cookieName=getChunkDataCookieName(id);qq.deleteCookie(cookieName);}}
function getPersistedChunkData(id){var chunkCookieValue=qq.getCookie(getChunkDataCookieName(id)),filename=api.getName(id),sections,uuid,partIndex,lastByteSent,initialRequestOverhead,estTotalRequestsSize;if(chunkCookieValue){sections=chunkCookieValue.split(cookieItemDelimiter);if(sections.length===5){uuid=sections[0];partIndex=parseInt(sections[1],10);lastByteSent=parseInt(sections[2],10);initialRequestOverhead=parseInt(sections[3],10);estTotalRequestsSize=parseInt(sections[4],10);return{uuid:uuid,part:partIndex,lastByteSent:lastByteSent,initialRequestOverhead:initialRequestOverhead,estTotalRequestsSize:estTotalRequestsSize};}
else{log('Ignoring previously stored resume/chunk cookie for '+filename+" - old cookie format","warn");}}}
function getChunkDataCookieName(id){var filename=api.getName(id),fileSize=api.getSize(id),maxChunkSize=options.chunking.partSize,cookieName;cookieName="qqfilechunk"+cookieItemDelimiter+encodeURIComponent(filename)+cookieItemDelimiter+fileSize+cookieItemDelimiter+maxChunkSize;if(resumeId!==undefined){cookieName+=cookieItemDelimiter+resumeId;}
return cookieName;}
function getResumeId(){if(options.resume.id!==null&&options.resume.id!==undefined&&!qq.isFunction(options.resume.id)&&!qq.isObject(options.resume.id)){return options.resume.id;}}
function handleFileChunkingUpload(id,retry){var name=api.getName(id),firstChunkIndex=0,persistedChunkInfoForResume,firstChunkDataForResume,currentChunkIndex;if(!fileState[id].remainingChunkIdxs||fileState[id].remainingChunkIdxs.length===0){fileState[id].remainingChunkIdxs=[];if(resumeEnabled&&!retry&&fileState[id].file){persistedChunkInfoForResume=getPersistedChunkData(id);if(persistedChunkInfoForResume){firstChunkDataForResume=getChunkData(id,persistedChunkInfoForResume.part);if(options.onResume(id,name,getChunkDataForCallback(firstChunkDataForResume))!==false){firstChunkIndex=persistedChunkInfoForResume.part;fileState[id].uuid=persistedChunkInfoForResume.uuid;fileState[id].loaded=persistedChunkInfoForResume.lastByteSent;fileState[id].estTotalRequestsSize=persistedChunkInfoForResume.estTotalRequestsSize;fileState[id].initialRequestOverhead=persistedChunkInfoForResume.initialRequestOverhead;fileState[id].attemptingResume=true;log('Resuming '+name+" at partition index "+firstChunkIndex);}}}
for(currentChunkIndex=getTotalChunks(id)-1;currentChunkIndex>=firstChunkIndex;currentChunkIndex-=1){fileState[id].remainingChunkIdxs.unshift(currentChunkIndex);}}
uploadNextChunk(id);}
function handleStandardFileUpload(id){var fileOrBlob=fileState[id].file||fileState[id].blobData.blob,name=api.getName(id),xhr,params,toSend;fileState[id].loaded=0;xhr=createXhr(id);xhr.upload.onprogress=function(e){if(e.lengthComputable){fileState[id].loaded=e.loaded;options.onProgress(id,name,e.loaded,e.total);}};xhr.onreadystatechange=getReadyStateChangeHandler(id,xhr);params=options.paramsStore.getParams(id);toSend=setParamsAndGetEntityToSend(params,xhr,fileOrBlob,id);setHeaders(id,xhr);log('Sending upload request for '+id);xhr.send(toSend);}
api={add:function(fileOrBlobData){var id;if(fileOrBlobData instanceof File){id=fileState.push({file:fileOrBlobData})-1;}
else if(qq.isBlob(fileOrBlobData.blob)){id=fileState.push({blobData:fileOrBlobData})-1;}
else{throw new Error('Passed obj in not a File or BlobData (in qq.UploadHandlerXhr)');}
fileState[id].uuid=qq.getUniqueId();return id;},getName:function(id){if(api.isValid(id)){var file=fileState[id].file,blobData=fileState[id].blobData;if(file){return(file.fileName!==null&&file.fileName!==undefined)?file.fileName:file.name;}
else{return blobData.name;}}
else{log(id+" is not a valid item ID.","error");}},getSize:function(id){var fileOrBlob=fileState[id].file||fileState[id].blobData.blob;if(qq.isFileOrInput(fileOrBlob)){return fileOrBlob.fileSize!=null?fileOrBlob.fileSize:fileOrBlob.size;}
else{return fileOrBlob.size;}},getFile:function(id){if(fileState[id]){return fileState[id].file||fileState[id].blobData.blob;}},getLoaded:function(id){return fileState[id].loaded||0;},isValid:function(id){return fileState[id]!==undefined;},reset:function(){fileState=[];},getUuid:function(id){return fileState[id].uuid;},upload:function(id,retry){var name=this.getName(id);options.onUpload(id,name);if(chunkFiles){handleFileChunkingUpload(id,retry);}
else{handleStandardFileUpload(id);}},cancel:function(id){var xhr=fileState[id].xhr;options.onCancel(id,this.getName(id));if(xhr){xhr.onreadystatechange=null;xhr.abort();}
if(resumeEnabled){deletePersistedChunkData(id);}
delete fileState[id];},getResumableFilesData:function(){var matchingCookieNames=[],resumableFilesData=[];if(chunkFiles&&resumeEnabled){if(resumeId===undefined){matchingCookieNames=qq.getCookieNames(new RegExp("^qqfilechunk\\"+cookieItemDelimiter+".+\\"+
cookieItemDelimiter+"\\d+\\"+cookieItemDelimiter+options.chunking.partSize+"="));}
else{matchingCookieNames=qq.getCookieNames(new RegExp("^qqfilechunk\\"+cookieItemDelimiter+".+\\"+
cookieItemDelimiter+"\\d+\\"+cookieItemDelimiter+options.chunking.partSize+"\\"+
cookieItemDelimiter+resumeId+"="));}
qq.each(matchingCookieNames,function(idx,cookieName){var cookiesNameParts=cookieName.split(cookieItemDelimiter);var cookieValueParts=qq.getCookie(cookieName).split(cookieItemDelimiter);resumableFilesData.push({name:decodeURIComponent(cookiesNameParts[1]),size:cookiesNameParts[2],uuid:cookieValueParts[0],partIdx:cookieValueParts[1]});});return resumableFilesData;}
return[];}};return api;};(function($){"use strict";var uploader,$el,init,dataStore,pluginOption,pluginOptions,addCallbacks,transformVariables,isValidCommand,delegateCommand;pluginOptions=['uploaderType'];init=function(options){if(options){var xformedOpts=transformVariables(options);addCallbacks(xformedOpts);if(pluginOption('uploaderType')==='basic'){uploader(new qq.FineUploaderBasic(xformedOpts));}
else{uploader(new qq.FineUploader(xformedOpts));}}
return $el;};dataStore=function(key,val){var data=$el.data('fineuploader');if(val){if(data===undefined){data={};}
data[key]=val;$el.data('fineuploader',data);}
else{if(data===undefined){return null;}
return data[key];}};uploader=function(instanceToStore){return dataStore('uploader',instanceToStore);};pluginOption=function(option,optionVal){return dataStore(option,optionVal);};addCallbacks=function(transformedOpts){var callbacks=transformedOpts.callbacks={},uploaderInst=new qq.FineUploaderBasic();$.each(uploaderInst._options.callbacks,function(prop,func){var name,$callbackEl;name=/^on(\w+)/.exec(prop)[1];name=name.substring(0,1).toLowerCase()+name.substring(1);$callbackEl=$el;callbacks[prop]=function(){var args=Array.prototype.slice.call(arguments);return $callbackEl.triggerHandler(name,args);};});};transformVariables=function(source,dest){var xformed,arrayVals;if(dest===undefined){if(source.uploaderType!=='basic'){xformed={element:$el[0]};}
else{xformed={};}}
else{xformed=dest;}
$.each(source,function(prop,val){if($.inArray(prop,pluginOptions)>=0){pluginOption(prop,val);}
else if(val instanceof $){xformed[prop]=val[0];}
else if($.isPlainObject(val)){xformed[prop]={};transformVariables(val,xformed[prop]);}
else if($.isArray(val)){arrayVals=[];$.each(val,function(idx,arrayVal){if(arrayVal instanceof $){$.merge(arrayVals,arrayVal);}
else{arrayVals.push(arrayVal);}});xformed[prop]=arrayVals;}
else{xformed[prop]=val;}});if(dest===undefined){return xformed;}};isValidCommand=function(command){return $.type(command)==="string"&&!command.match(/^_/)&&uploader()[command]!==undefined;};delegateCommand=function(command){var xformedArgs=[],origArgs=Array.prototype.slice.call(arguments,1);transformVariables(origArgs,xformedArgs);return uploader()[command].apply(uploader(),xformedArgs);};$.fn.fineUploader=function(optionsOrCommand){var self=this,selfArgs=arguments,retVals=[];this.each(function(index,el){$el=$(el);if(uploader()&&isValidCommand(optionsOrCommand)){retVals.push(delegateCommand.apply(self,selfArgs));if(self.length===1){return false;}}
else if(typeof optionsOrCommand==='object'||!optionsOrCommand){init.apply(self,selfArgs);}
else{$.error('Method '+optionsOrCommand+' does not exist on jQuery.fineUploader');}});if(retVals.length===1){return retVals[0];}
else if(retVals.length>1){return retVals;}
return this;};}(jQuery));(function($){"use strict";var rootDataKey="fineUploaderDnd",$el;function init(options){if(!options){options={};}
options.dropZoneElements=[$el];var xformedOpts=transformVariables(options);addCallbacks(xformedOpts);dnd(new qq.DragAndDrop(xformedOpts));return $el;};function dataStore(key,val){var data=$el.data(rootDataKey);if(val){if(data===undefined){data={};}
data[key]=val;$el.data(rootDataKey,data);}
else{if(data===undefined){return null;}
return data[key];}};function dnd(instanceToStore){return dataStore('dndInstance',instanceToStore);};function addCallbacks(transformedOpts){var callbacks=transformedOpts.callbacks={},dndInst=new qq.FineUploaderBasic();$.each(new qq.DragAndDrop.callbacks(),function(prop,func){var name=prop,$callbackEl;$callbackEl=$el;callbacks[prop]=function(){var args=Array.prototype.slice.call(arguments),jqueryHandlerResult=$callbackEl.triggerHandler(name,args);return jqueryHandlerResult;};});};function transformVariables(source,dest){var xformed,arrayVals;if(dest===undefined){xformed={};}
else{xformed=dest;}
$.each(source,function(prop,val){if(val instanceof $){xformed[prop]=val[0];}
else if($.isPlainObject(val)){xformed[prop]={};transformVariables(val,xformed[prop]);}
else if($.isArray(val)){arrayVals=[];$.each(val,function(idx,arrayVal){if(arrayVal instanceof $){$.merge(arrayVals,arrayVal);}
else{arrayVals.push(arrayVal);}});xformed[prop]=arrayVals;}
else{xformed[prop]=val;}});if(dest===undefined){return xformed;}};function isValidCommand(command){return $.type(command)==="string"&&command==="dispose"&&dnd()[command]!==undefined;};function delegateCommand(command){var xformedArgs=[],origArgs=Array.prototype.slice.call(arguments,1);transformVariables(origArgs,xformedArgs);return dnd()[command].apply(dnd(),xformedArgs);};$.fn.fineUploaderDnd=function(optionsOrCommand){var self=this,selfArgs=arguments,retVals=[];this.each(function(index,el){$el=$(el);if(dnd()&&isValidCommand(optionsOrCommand)){retVals.push(delegateCommand.apply(self,selfArgs));if(self.length===1){return false;}}
else if(typeof optionsOrCommand==='object'||!optionsOrCommand){init.apply(self,selfArgs);}
else{$.error("Method "+optionsOrCommand+" does not exist in Fine Uploader's DnD module.");}});if(retVals.length===1){return retVals[0];}
else if(retVals.length>1){return retVals;}
return this;};}(jQuery));$(function(){function initUploadArea(postId){var $post=$("#"+postId);var $attachments=$post.find('.attachments-edit ul');var uploader=new qq.FineUploaderBasic({debug:true,button:$post.find('.attachments-button')[0],request:{endpoint:ET.webPath+'/?p=attachment/upload',params:{postId:postId=="reply"?(ETConversation.id?"c"+ETConversation.id:"c0"):postId}},callbacks:{onSubmit:function(id,fileName){$attachments.append('<li id="file-'+postId+'-'+id+'"></li>');},onUpload:function(id,fileName){$('#file-'+postId+'-'+id).addClass('attachment-uploading').html('Initializing “'+fileName+'”...');},onProgress:function(id,fileName,loaded,total){if(loaded<total){progress=Math.round(loaded/total*100)+'% of '+Math.round(total/1024)+' kB';$('#file-'+postId+'-'+id).html('Uploading “'+fileName+'” '+progress);}else{$('#file-'+postId+'-'+id).html('Saving “'+fileName+'”...');}},onComplete:function(id,fileName,responseJSON){if(responseJSON.success){$('#file-'+postId+'-'+id).removeClass('attachment-uploading').html('<a href="#" class="control-delete" title="Delete" data-id="'+id+'"><i class="icon-remove"></i></a> <strong>'+fileName+'</strong>');}else{$('#file-'+postId+'-'+id).remove();ETMessages.showMessage('Error uploading "'+fileName+'": '+responseJSON.error,{className:"warning dismissable",id:"attachmentUploadError"});}}}});var dragAndDropModule=new qq.DragAndDrop({dropZoneElements:[$post.find(".dropZone")[0]],classes:{dropActive:"dropZoneActive"},hideDropZonesBeforeEnter:true,callbacks:{processingDroppedFiles:function(){},processingDroppedFilesComplete:function(files){uploader.addFiles(files);}}});$post.on("click",".attachments-edit .control-delete",function(e){e.preventDefault();$.ETAjax({url:"attachment/remove/"+$(this).data("id")});$(this).parent().remove();});}
initUploadArea("reply");ETConversation._updateEditPost=ETConversation.updateEditPost;ETConversation.updateEditPost=function(postId,html){ETConversation._updateEditPost(postId,html);initUploadArea("p"+postId);};ETConversation._resetReply=ETConversation.resetReply;ETConversation.resetReply=function(){ETConversation._resetReply();$("#reply .attachments ul").html("");};});$(function(){if($("#conversationStatusControls").length)
$("#conversationBody .scrubberContent").prepend($("#conversationStatusControls").popup({alignment:"left",content:"<i class='icon-pushpin'></i> <span class='text'>Sildid</span> <i class='icon-caret-down'></i>"}).find(".button").addClass("big").end());});